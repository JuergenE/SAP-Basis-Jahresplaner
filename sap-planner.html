<!--
  Copyright 2026 Optima Solutions GmbH

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0
-->
<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SAP Basis Jahresplaner 0.1.6</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin
    src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.26.4/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ===== Original Styles ===== */
    .weekend-pattern {
      background: repeating-linear-gradient(45deg,
          transparent,
          transparent 3px,
          rgba(156, 163, 175, 0.3) 3px,
          rgba(156, 163, 175, 0.3) 6px);
    }

    .holiday-pattern {
      background: repeating-linear-gradient(-45deg,
          transparent,
          transparent 3px,
          rgba(239, 68, 68, 0.2) 3px,
          rgba(239, 68, 68, 0.2) 6px);
    }

    .maintenance-pattern {
      background: repeating-linear-gradient(45deg,
          transparent,
          transparent 3px,
          rgba(139, 92, 246, 0.35) 3px,
          rgba(139, 92, 246, 0.35) 6px);
    }

    .today-marker {
      box-shadow: inset 0 0 0 2px #ef4444;
    }

    .activity-bar {
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .activity-bar:hover {
      transform: scaleY(1.1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }

    @media (max-width: 640px) {
      .gantt-row-label {
        min-width: 100px !important;
        font-size: 0.75rem;
      }

      .header-controls {
        flex-direction: column;
        gap: 0.5rem;
      }
    }

    /* ===== Dark Mode Toggle Switch ===== */
    .dark-toggle {
      position: relative;
      width: 56px;
      height: 28px;
      border-radius: 14px;
      background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
      cursor: pointer;
      border: none;
      padding: 0;
      transition: background 0.4s ease;
      flex-shrink: 0;
    }

    .dark-toggle::after {
      content: '‚òÄÔ∏è';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: transform 0.4s cubic-bezier(.68, -0.55, .27, 1.55), background 0.4s ease;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    }

    .dark-mode .dark-toggle {
      background: linear-gradient(135deg, #6272a4, #44475a);
    }

    .dark-mode .dark-toggle::after {
      content: 'üåô';
      transform: translateX(28px);
      background: #282a36;
    }

    /* ===== Dark Mode ‚Äî Dracula Palette Overrides ===== */
    /* Transition for smooth theme switching */
    html.dark-mode-transition,
    html.dark-mode-transition *,
    html.dark-mode-transition *::before,
    html.dark-mode-transition *::after {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease !important;
    }

    /* Page background */
    .dark-mode body {
      background: #282a36 !important;
      color: #f8f8f2 !important;
    }

    .dark-mode .bg-gradient-to-br {
      background: #282a36 !important;
    }

    .dark-mode .from-slate-50 {
      --tw-gradient-from: #282a36 !important;
    }

    .dark-mode .to-slate-100 {
      --tw-gradient-to: #282a36 !important;
    }

    /* Cards and containers */
    .dark-mode .bg-white {
      background-color: #44475a !important;
    }

    .dark-mode .bg-gray-50 {
      background-color: #383a4a !important;
    }

    .dark-mode .bg-gray-100 {
      background-color: #383a4a !important;
    }

    .dark-mode .bg-gray-200 {
      background-color: #4a4d5e !important;
    }

    .dark-mode .hover\:bg-gray-50:hover {
      background-color: #4a4d5e !important;
    }

    .dark-mode .hover\:bg-gray-100:hover {
      background-color: #4a4d5e !important;
    }

    .dark-mode .hover\:bg-gray-300:hover {
      background-color: #555869 !important;
    }

    /* Text colors ‚Äî catch-all: set default on root so everything inherits */
    .dark-mode {
      color: #f8f8f2 !important;
    }

    .dark-mode .text-gray-900,
    .dark-mode .text-gray-800,
    .dark-mode .text-gray-700 {
      color: #f8f8f2 !important;
    }

    .dark-mode .text-black {
      color: #f8f8f2 !important;
    }

    .dark-mode p,
    .dark-mode td,
    .dark-mode th,
    .dark-mode li,
    .dark-mode div,
    .dark-mode span,
    .dark-mode label {
      color: #f8f8f2;
    }

    .dark-mode .text-gray-600 {
      color: #bfc4d6 !important;
    }

    .dark-mode .text-gray-500 {
      color: #9ca3c0 !important;
    }

    .dark-mode .text-gray-400 {
      color: #6272a4 !important;
    }

    .dark-mode .hover\\:text-gray-800:hover {
      color: #f8f8f2 !important;
    }

    .dark-mode .text-blue-700 {
      color: #bd93f9 !important;
    }

    .dark-mode .text-blue-600 {
      color: #bd93f9 !important;
    }

    .dark-mode .text-purple-700 {
      color: #d6acff !important;
    }

    .dark-mode .text-red-600 {
      color: #ff6e6e !important;
    }

    .dark-mode h1,
    .dark-mode h2,
    .dark-mode h3 {
      color: #f8f8f2 !important;
    }

    .dark-mode .font-semibold,
    .dark-mode .font-bold {
      color: #f8f8f2 !important;
    }

    .dark-mode .text-xs,
    .dark-mode .text-sm {
      color: inherit;
    }

    /* Borders */
    .dark-mode .border-gray-200,
    .dark-mode .border-gray-300 {
      border-color: #6272a4 !important;
    }

    .dark-mode .border-blue-300 {
      border-color: #6272a4 !important;
    }

    .dark-mode .border-blue-600 {
      border-color: #bd93f9 !important;
    }

    .dark-mode .border-t {
      border-color: #6272a4;
    }

    /* Dark mode: delete confirmation bar */
    .dark-mode .bg-red-50 {
      background-color: rgba(139, 0, 0, 0.2) !important;
    }

    .dark-mode .text-red-700 {
      color: #ff6e6e !important;
    }

    .dark-mode .border-red-200,
    .dark-mode .border-red-300 {
      border-color: #8b3a3a !important;
    }

    .dark-mode button {
      color: inherit;
    }

    /* Inputs and selects */
    .dark-mode input[type="text"],
    .dark-mode input[type="number"],
    .dark-mode input[type="password"],
    .dark-mode input[type="date"],
    .dark-mode select,
    .dark-mode textarea {
      background-color: #383a4a !important;
      color: #f8f8f2 !important;
      border-color: #6272a4 !important;
    }

    /* Booked training green override - must beat dark-mode !important above */
    .booked-green,
    .dark-mode .booked-green,
    .dark-mode select.booked-green,
    .dark-mode input.booked-green,
    .dark-mode td.booked-green {
      background-color: #00b050 !important;
      color: #ffffff !important;
      border-color: #00b050 !important;
    }

    /* Dark mode: Role badge overrides for Benutzerverwaltung */
    .dark-mode .bg-amber-100 {
      background-color: #805b10 !important;
    }

    .dark-mode .text-amber-700 {
      color: #fde68a !important;
    }

    .dark-mode .bg-purple-100 {
      background-color: #5b21b6 !important;
    }

    .dark-mode .text-purple-700 {
      color: #e9d5ff !important;
    }

    .dark-mode .bg-sky-100 {
      background-color: #0c4a6e !important;
    }

    .dark-mode .text-sky-700 {
      color: #bae6fd !important;
    }

    .dark-mode .bg-gray-100.text-gray-600 {
      background-color: #4a4d5e !important;
      color: #d1d5db !important;
    }

    .dark-mode input::placeholder,
    .dark-mode textarea::placeholder {
      color: #6272a4 !important;
    }

    .dark-mode option {
      background-color: #383a4a;
      color: #f8f8f2;
    }

    /* Shadow adjustments */
    .dark-mode .shadow-lg {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.3) !important;
    }

    .dark-mode .shadow-xl {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.4) !important;
    }

    /* Modal overlay */
    .dark-mode .bg-black\/50,
    .dark-mode [class*="bg-black"] {
      background-color: rgba(0, 0, 0, 0.7) !important;
    }

    /* Patterns for dark mode */
    .dark-mode .weekend-pattern {
      background: repeating-linear-gradient(45deg,
          transparent,
          transparent 3px,
          rgba(98, 114, 164, 0.35) 3px,
          rgba(98, 114, 164, 0.35) 6px);
    }

    .dark-mode .holiday-pattern {
      background: repeating-linear-gradient(-45deg,
          transparent,
          transparent 3px,
          rgba(255, 85, 85, 0.25) 3px,
          rgba(255, 85, 85, 0.25) 6px);
    }

    .dark-mode .maintenance-pattern {
      background: repeating-linear-gradient(45deg,
          transparent,
          transparent 3px,
          rgba(189, 147, 249, 0.3) 3px,
          rgba(189, 147, 249, 0.3) 6px);
    }

    /* Buttons ‚Äî keep colored buttons, darken gray ones */
    .dark-mode .bg-blue-100 {
      background-color: rgba(189, 147, 249, 0.2) !important;
    }

    .dark-mode .hover\:bg-blue-200:hover {
      background-color: rgba(189, 147, 249, 0.3) !important;
    }

    .dark-mode .bg-purple-50 {
      background-color: rgba(189, 147, 249, 0.15) !important;
    }

    .dark-mode .hover\:bg-purple-50:hover {
      background-color: rgba(189, 147, 249, 0.2) !important;
    }

    .dark-mode .bg-red-100 {
      background-color: rgba(255, 85, 85, 0.2) !important;
    }

    .dark-mode .hover\:bg-red-200:hover {
      background-color: rgba(255, 85, 85, 0.3) !important;
    }

    /* Gantt row label */
    .dark-mode .gantt-row-label {
      color: #f8f8f2;
    }

    /* Range slider */
    .dark-mode input[type="range"] {
      accent-color: #bd93f9;
    }

    /* Checkbox */
    .dark-mode input[type="checkbox"] {
      accent-color: #bd93f9;
    }

    /* Scrollbar for dark mode */
    .dark-mode ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .dark-mode ::-webkit-scrollbar-track {
      background: #282a36;
    }

    .dark-mode ::-webkit-scrollbar-thumb {
      background: #6272a4;
      border-radius: 4px;
    }

    .dark-mode ::-webkit-scrollbar-thumb:hover {
      background: #bd93f9;
    }

    /* Table for dark mode */
    .dark-mode table {
      color: #f8f8f2;
    }

    .dark-mode th {
      background-color: #383a4a !important;
      color: #f8f8f2 !important;
      border-color: #6272a4 !important;
    }

    .dark-mode td {
      border-color: #6272a4 !important;
    }

    .dark-mode tr:hover td {
      background-color: rgba(98, 114, 164, 0.15);
    }

    .dark-mode .bg-gray-600 {
      background-color: #555869 !important;
    }

    .dark-mode .hover\:bg-gray-700:hover {
      background-color: #4a4d5e !important;
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <!-- Init dark mode from localStorage BEFORE React renders to prevent flash -->
  <script>
    (function () {
      try {
        if (localStorage.getItem('darkMode') === 'true') {
          document.documentElement.classList.add('dark-mode');
        }
      } catch (e) { }
    })();
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    // =========================================================================
    // API CLIENT
    // =========================================================================



    class ApiClient {
      constructor() {
        // Token is managed via HttpOnly cookie

        // Configuration: API Base URL
        // Leave empty ('') if frontend and backend run on the same server (default).
        // If running strictly as client (file:// or different server), set the full URL.

        // BEFORE (local development):
        // this.baseUrl = 'http://localhost:3232';

        // AFTER (production):
        // this.baseUrl = 'http://YOUR_SERVER_IP:3232';
        // Example:
        // this.baseUrl = 'http://192.168.1.100:3232';
        // Or with hostname:
        // this.baseUrl = 'http://sap-planner.yourcompany.local:3232';

        this.baseUrl = '';
      }

      setToken(token) {
        // No-op: Token is set by server via HttpOnly cookie
      }

      async request(endpoint, options = {}) {
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        // Authorization header is no longer needed (cookie is sent automatically)

        const url = `${this.baseUrl}${endpoint}`;
        console.log(`[API] Fetching: ${url}`, options);

        try {
          const response = await fetch(url, {
            ...options,
            headers,
            credentials: 'include'
          });

          const data = await response.json();
          console.log(`[API] Response from ${endpoint}:`, data);

          if (response.status === 401) {
            if (!endpoint.includes('/login')) {
              throw new Error('SESSION_EXPIRED');
            }
            throw new Error(data.error || 'Ung√ºltige Anmeldedaten');
          }

          if (!response.ok) {
            throw new Error(data.error || 'API Fehler');
          }
          return data;
        } catch (error) {
          console.error(`[API] Error on ${endpoint}:`, error);
          throw error;
        }
      }

      // Auth
      async login(username, password) {
        // Token is set as HttpOnly cookie by server
        const data = await this.request('/api/auth/login', {
          method: 'POST',
          body: JSON.stringify({ username, password })
        });
        return { ...data.user, version: data.user.version || data.version };
      }

      async logout() {
        try { await this.request('/api/auth/logout', { method: 'POST' }); } catch { }
        // Server clears cookie
      }

      async getMe() { return this.request('/api/auth/me'); }
      async changePassword(currentPassword, newPassword) {
        return this.request('/api/auth/change-password', {
          method: 'POST',
          body: JSON.stringify({ currentPassword, newPassword })
        });
      }

      // Settings
      async getSettings() { return this.request('/api/settings'); }
      async updateSettings(settings) { return this.request('/api/settings', { method: 'PUT', body: JSON.stringify(settings) }); }

      // Activity Types
      async getActivityTypes() { return this.request('/api/activity-types'); }
      async createActivityType(type) { return this.request('/api/activity-types', { method: 'POST', body: JSON.stringify(type) }); }
      async updateActivityType(id, data) { return this.request(`/api/activity-types/${id}`, { method: 'PUT', body: JSON.stringify(data) }); }
      async deleteActivityType(id) { return this.request(`/api/activity-types/${id}`, { method: 'DELETE' }); }

      // Landscapes
      async getLandscapes() { return this.request('/api/landscapes'); }
      async createLandscape(name) { return this.request('/api/landscapes', { method: 'POST', body: JSON.stringify({ name }) }); }
      async updateLandscape(id, data) { return this.request(`/api/landscapes/${id}`, { method: 'PUT', body: JSON.stringify(data) }); }
      async deleteLandscape(id) { return this.request(`/api/landscapes/${id}`, { method: 'DELETE' }); }

      // Landscape Locking
      async acquireLock(id) { return this.request(`/api/landscapes/${id}/lock`, { method: 'POST' }); }
      async releaseLock(id) { return this.request(`/api/landscapes/${id}/lock`, { method: 'DELETE' }); }

      // SIDs
      async createSid(landscape_id, name, is_prd, visible_in_gantt) { return this.request('/api/sids', { method: 'POST', body: JSON.stringify({ landscape_id, name, is_prd, visible_in_gantt }) }); }
      async updateSid(id, data) { return this.request(`/api/sids/${id}`, { method: 'PUT', body: JSON.stringify(data) }); }
      async deleteSid(id) { return this.request(`/api/sids/${id}`, { method: 'DELETE' }); }
      async copySid(id, target_landscape_id, new_name) {
        return this.request(`/api/sids/${id}/copy`, {
          method: 'POST',
          body: JSON.stringify({ target_landscape_id, new_name })
        });
      }

      // Activities
      async createActivity(data) { return this.request('/api/activities', { method: 'POST', body: JSON.stringify(data) }); }
      async updateActivity(id, data) { return this.request(`/api/activities/${id}`, { method: 'PUT', body: JSON.stringify(data) }); }
      async deleteActivity(id) { return this.request(`/api/activities/${id}`, { method: 'DELETE' }); }

      // Sub-Activities
      async createSubActivity(data) { return this.request('/api/sub-activities', { method: 'POST', body: JSON.stringify(data) }); }
      async updateSubActivity(id, data) { return this.request(`/api/sub-activities/${id}`, { method: 'PUT', body: JSON.stringify(data) }); }
      async deleteSubActivity(id) { return this.request(`/api/sub-activities/${id}`, { method: 'DELETE' }); }

      // Team Members
      async getTeamMembers() { return this.request('/api/team-members'); }
      async createTeamMember(data) { return this.request('/api/team-members', { method: 'POST', body: JSON.stringify(data) }); }
      async updateTeamMember(id, data) { return this.request(`/api/team-members/${id}`, { method: 'PUT', body: JSON.stringify(data) }); }
      async deleteTeamMember(id) { return this.request(`/api/team-members/${id}`, { method: 'DELETE' }); }

      // Users
      async getUsers() { return this.request('/api/users'); }
      async createUser(data) { return this.request('/api/users', { method: 'POST', body: JSON.stringify(data) }); }
      async updateUser(id, data) { return this.request(`/api/users/${id}`, { method: 'PUT', body: JSON.stringify(data) }); }
      async deleteUser(id) { return this.request(`/api/users/${id}`, { method: 'DELETE' }); }
      async ping() { return this.request('/api/users/ping', { method: 'POST' }); }
      async getOnlineUsers() { return this.request('/api/users/online'); }

      // Import
      async importJson(data) { return this.request('/api/import/json', { method: 'POST', body: JSON.stringify(data) }); }

      // Logs
      async getLogs(limit = 100) { return this.request(`/api/logs?limit=${limit}`); }

      // Maintenance Sundays
      async getMaintenanceSundays() { return this.request('/api/maintenance-sundays'); }
      async updateMaintenanceSunday(id, date, label) {
        return this.request(`/api/maintenance-sundays/${id}`, {
          method: 'PUT',
          body: JSON.stringify({ date, label })
        });
      }

      // Backup/Restore (Teamlead only)
      async exportBackup() {
        const response = await fetch(`${this.baseUrl}/api/backup/export`, {
          credentials: 'include'
        });
        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: 'Backup-Export fehlgeschlagen' }));
          throw new Error(error.error || 'Backup-Export fehlgeschlagen');
        }
        return response.json();
      }
      async importBackup(data) {
        return this.request('/api/backup/import', { method: 'POST', body: JSON.stringify(data) });
      }

      // Dark Mode preference (per-user)
      async setDarkMode(enabled) {
        return this.request('/api/auth/dark-mode', { method: 'PUT', body: JSON.stringify({ dark_mode: enabled }) });
      }

      // Toggle SID Gantt visibility (available to all users)
      async toggleSidVisibility(sidId, visible) {
        return this.request(`/api/sids/${sidId}/visibility`, { method: 'PATCH', body: JSON.stringify({ visible_in_gantt: visible }) });
      }

      // Matrix & Trainings
      async getMatrix() { return this.request('/api/matrix'); }
      async createMatrixColumn(name) { return this.request('/api/matrix/columns', { method: 'POST', body: JSON.stringify({ name }) }); }
      async updateMatrixColumn(id, name, sort_order) { return this.request(`/api/matrix/columns/${id}`, { method: 'PUT', body: JSON.stringify({ name, sort_order }) }); }
      async deleteMatrixColumn(id) { return this.request(`/api/matrix/columns/${id}`, { method: 'DELETE' }); }
      async updateMatrixValue(teamMemberId, columnId, level) { return this.request('/api/matrix/values', { method: 'PUT', body: JSON.stringify({ teamMemberId, columnId, level }) }); }

      async getTrainings() { return this.request('/api/trainings'); }
      async createTraining() { return this.request('/api/trainings', { method: 'POST' }); }
      async updateTraining(id, data) { return this.request(`/api/trainings/${id}`, { method: 'PUT', body: JSON.stringify(data) }); }
      async deleteTraining(id) { return this.request(`/api/trainings/${id}`, { method: 'DELETE' }); }
    }

    const api = new ApiClient();

    const APP_VERSION_FALLBACK = '0.1.6';

    const bundeslaender = [
      { id: 'BW', name: 'Baden-W√ºrttemberg' },
      { id: 'BY', name: 'Bayern' },
      { id: 'BE', name: 'Berlin' },
      { id: 'BB', name: 'Brandenburg' },
      { id: 'HB', name: 'Bremen' },
      { id: 'HH', name: 'Hamburg' },
      { id: 'HE', name: 'Hessen' },
      { id: 'MV', name: 'Mecklenburg-Vorpommern' },
      { id: 'NI', name: 'Niedersachsen' },
      { id: 'NW', name: 'Nordrhein-Westfalen' },
      { id: 'RP', name: 'Rheinland-Pfalz' },
      { id: 'SL', name: 'Saarland' },
      { id: 'SN', name: 'Sachsen' },
      { id: 'ST', name: 'Sachsen-Anhalt' },
      { id: 'SH', name: 'Schleswig-Holstein' },
      { id: 'TH', name: 'Th√ºringen' }
    ];

    const defaultActivityTypes = [
      { id: 'installation', label: 'Installation', color: '#3b82f6' },
      { id: 'update', label: 'Update/Upgrade', color: '#8b5cf6' },
      { id: 'kernel', label: 'Kernel Update', color: '#06b6d4' },
      { id: 'db', label: 'DB Update', color: '#10b981' },
      { id: 'os', label: 'OS Patches', color: '#f59e0b' },
      { id: 'stpi', label: 'ST-PI Patches', color: '#ef4444' },
      { id: 'security', label: 'Security Patches', color: '#ec4899' },
      { id: 'other', label: 'Sonstige', color: '#6b7280' }
    ];

    // Predefined colors for new activity types
    const availableColors = [
      '#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b',
      '#ef4444', '#ec4899', '#6b7280', '#14b8a6', '#f97316',
      '#84cc16', '#a855f7', '#0ea5e9', '#d946ef', '#22c55e'
    ];

    // Weekday letters: Monday to Sunday (ISO week starts Monday)
    const weekDayLetters = ['M', 'D', 'M', 'D', 'F', 'S', 'S'];

    const defaultData = {
      year: 2026,
      bundesland: 'BW',
      landscapes: [
        {
          id: 1,
          name: 'ERP Landschaft',
          sids: [
            { id: 1, name: 'RTT', isPRD: false, activities: [] },
            { id: 2, name: 'RTI', isPRD: false, activities: [] },
            { id: 3, name: 'DB3', isPRD: true, activities: [] }
          ]
        },
        {
          id: 2,
          name: 'SAP Solution Manager Landschaft',
          sids: [
            { id: 4, name: 'SOT', isPRD: false, activities: [] },
            { id: 5, name: 'SOQ', isPRD: false, activities: [] },
            { id: 6, name: 'SOL', isPRD: true, activities: [] }
          ]
        }
      ]
    };

    // =========================================================================
    // UTILITY FUNCTIONS
    // =========================================================================

    // Calculate Easter using Gauss algorithm
    const getEasterDate = (year) => {
      const a = year % 19;
      const b = Math.floor(year / 100);
      const c = year % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const l = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * l) / 451);
      const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
      const day = ((h + l - 7 * m + 114) % 31) + 1;
      return new Date(year, month, day);
    };

    // Get all German holidays for a year and federal state
    const getGermanHolidays = (year, bundesland) => {
      const holidays = new Map();
      // Use local date formatting to avoid timezone issues with toISOString()
      const addHoliday = (date, name) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        holidays.set(`${y}-${m}-${d}`, name);
      };

      // Fixed holidays (nationwide)
      addHoliday(new Date(year, 0, 1), 'Neujahr');
      addHoliday(new Date(year, 4, 1), 'Tag der Arbeit');
      addHoliday(new Date(year, 9, 3), 'Tag der Deutschen Einheit');
      addHoliday(new Date(year, 11, 25), '1. Weihnachtstag');
      addHoliday(new Date(year, 11, 26), '2. Weihnachtstag');

      // Easter-based holidays
      const easter = getEasterDate(year);

      const karfreitag = new Date(easter);
      karfreitag.setDate(easter.getDate() - 2);
      addHoliday(karfreitag, 'Karfreitag');

      const ostermontag = new Date(easter);
      ostermontag.setDate(easter.getDate() + 1);
      addHoliday(ostermontag, 'Ostermontag');

      const christiHimmelfahrt = new Date(easter);
      christiHimmelfahrt.setDate(easter.getDate() + 39);
      addHoliday(christiHimmelfahrt, 'Christi Himmelfahrt');

      const pfingstmontag = new Date(easter);
      pfingstmontag.setDate(easter.getDate() + 50);
      addHoliday(pfingstmontag, 'Pfingstmontag');

      // State-specific holidays
      if (['BW', 'BY', 'ST'].includes(bundesland)) {
        addHoliday(new Date(year, 0, 6), 'Heilige Drei K√∂nige');
      }

      if (['BW', 'BY', 'HE', 'NW', 'RP', 'SL'].includes(bundesland)) {
        const fronleichnam = new Date(easter);
        fronleichnam.setDate(easter.getDate() + 60);
        addHoliday(fronleichnam, 'Fronleichnam');
      }

      if (['BY', 'SL'].includes(bundesland)) {
        addHoliday(new Date(year, 7, 15), 'Mari√§ Himmelfahrt');
      }

      if (['BB', 'MV', 'SN', 'ST', 'TH'].includes(bundesland)) {
        addHoliday(new Date(year, 9, 31), 'Reformationstag');
      }

      if (['BW', 'BY', 'NW', 'RP', 'SL'].includes(bundesland)) {
        addHoliday(new Date(year, 10, 1), 'Allerheiligen');
      }

      if (bundesland === 'SN') {
        // Bu√ü- und Bettag: Wednesday before Nov 23
        const nov23 = new Date(year, 10, 23);
        const dayOfWeek = nov23.getDay();
        const daysToWednesday = (dayOfWeek + 4) % 7;
        const bussUndBettag = new Date(nov23);
        bussUndBettag.setDate(nov23.getDate() - daysToWednesday);
        addHoliday(bussUndBettag, 'Bu√ü- und Bettag');
      }

      return holidays;
    };

    // Check if a date is a weekend (Saturday=6, Sunday=0)
    const isWeekend = (date) => {
      const day = date.getDay();
      return day === 0 || day === 6;
    };

    // Get weekday index (0=Monday, 6=Sunday) from JavaScript Date
    const getWeekdayIndex = (date) => {
      const day = date.getDay();
      return day === 0 ? 6 : day - 1; // Convert: Sun=0 -> 6, Mon=1 -> 0, etc.
    };

    // Calculate ISO week number
    const getISOWeekNumber = (date) => {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    };

    // Get Monday of the week containing a date
    const getMondayOfWeek = (date) => {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff);
      return d;
    };

    // Calculate end date based on working days
    // Duration = 1 means start date = end date (start day is the first working day)
    // For PRD systems: weekends (Sat/Sun) ARE working days (work happens on weekends)
    // For non-PRD systems: weekends are NOT working days
    const calculateEndDate = (startDateStr, durationDays, year, bundesland, isPRD = false) => {
      const holidays = getGermanHolidays(year, bundesland);
      const holidayDates = new Set(holidays.keys());

      let current = new Date(startDateStr);
      let workingDaysCount = 0;

      while (workingDaysCount < durationDays) {
        const dateStr = formatDateISO(current);
        const dayOfWeek = current.getDay();

        let isWorkingDay;
        if (isPRD) {
          // PRD systems: weekends ARE working days, only holidays are excluded
          isWorkingDay = !holidayDates.has(dateStr);
        } else {
          // Non-PRD systems: weekends and holidays are NOT working days
          isWorkingDay = dayOfWeek !== 0 && dayOfWeek !== 6 && !holidayDates.has(dateStr);
        }

        if (isWorkingDay) {
          workingDaysCount++;
          if (workingDaysCount >= durationDays) {
            break;
          }
        }

        current.setDate(current.getDate() + 1);
      }

      return formatDateISO(current);
    };

    // Adjust start date for PRD systems (move to Saturday)
    const adjustStartDateForPRD = (startDateStr, isPRD) => {
      if (!isPRD) return startDateStr;

      const date = new Date(startDateStr);
      const day = date.getDay();

      if (day !== 6) {
        const daysUntilSaturday = (6 - day + 7) % 7 || 7;
        date.setDate(date.getDate() + daysUntilSaturday);
      }

      return date.toISOString().split('T')[0];
    };

    // Format date as German locale
    const formatDateDE = (dateStr) => {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
    };

    // Format date for comparison (YYYY-MM-DD)
    const formatDateISO = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };

    // Calculate activity segments (split at weekends/holidays for non-PRD systems)
    const getActivitySegments = (startDateStr, endDateStr, isPRD, holidays) => {
      const segments = [];
      const holidayDates = new Set(holidays.keys());

      const start = new Date(startDateStr);
      const end = new Date(endDateStr);

      // For PRD systems, return single continuous segment
      if (isPRD) {
        return [{ start: startDateStr, end: endDateStr }];
      }

      // For non-PRD systems, split at weekends and holidays
      let currentSegmentStart = null;
      let currentDate = new Date(start);

      while (currentDate <= end) {
        const dateStr = formatDateISO(currentDate);
        const dayOfWeek = currentDate.getDay();
        const isNonWorkingDay = dayOfWeek === 0 || dayOfWeek === 6 || holidayDates.has(dateStr);

        if (!isNonWorkingDay) {
          // Working day
          if (currentSegmentStart === null) {
            currentSegmentStart = dateStr;
          }
        } else {
          // Non-working day - close current segment if open
          if (currentSegmentStart !== null) {
            const prevDate = new Date(currentDate);
            prevDate.setDate(prevDate.getDate() - 1);
            segments.push({
              start: currentSegmentStart,
              end: formatDateISO(prevDate)
            });
            currentSegmentStart = null;
          }
        }

        currentDate.setDate(currentDate.getDate() + 1);
      }

      // Close final segment
      if (currentSegmentStart !== null) {
        segments.push({
          start: currentSegmentStart,
          end: formatDateISO(end)
        });
      }

      return segments;
    };

    // =========================================================================
    // ICONS
    // =========================================================================

    const CalendarIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );

    const PlusIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const SaveIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
        <polyline points="17 21 17 13 7 13 7 21"></polyline>
        <polyline points="7 3 7 8 15 8"></polyline>
      </svg>
    );

    const DocumentDuplicateIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
      </svg>
    );

    const DownloadIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const TrashIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    );

    const ChevronLeftIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    );

    const ChevronRightIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    );

    const UploadIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
    );

    // =========================================================================
    // MAIN APPLICATION
    // =========================================================================

    const SAPBasisPlanner = () => {
      // Auth state
      const [user, setUser] = useState(null);
      const [loginError, setLoginError] = useState('');
      const [loading, setLoading] = useState(true);
      const [mustChangePassword, setMustChangePassword] = useState(false);

      // Dark mode state (initialized from localStorage for pre-login, synced with server after login)
      const [darkMode, setDarkMode] = useState(() => {
        try { return localStorage.getItem('darkMode') === 'true'; } catch (e) { return false; }
      });

      // Helper: apply dark mode CSS class and sync localStorage
      const applyDarkMode = useCallback((enabled) => {
        document.documentElement.classList.add('dark-mode-transition');
        if (enabled) {
          document.documentElement.classList.add('dark-mode');
        } else {
          document.documentElement.classList.remove('dark-mode');
        }
        try { localStorage.setItem('darkMode', String(enabled)); } catch (e) { }
        setTimeout(() => document.documentElement.classList.remove('dark-mode-transition'), 350);
        setDarkMode(enabled);
      }, []);

      // Toggle dark mode and save to server
      const toggleDarkMode = useCallback(() => {
        setDarkMode(prev => {
          const next = !prev;
          applyDarkMode(next);
          // Save to server (fire-and-forget)
          api.setDarkMode(next).catch(() => { });
          return next;
        });
      }, [applyDarkMode]);

      // App state
      const [year, setYear] = useState(2026);
      const [bundesland, setBundesland] = useState('BW');
      const [landscapes, setLandscapes] = useState([]);
      // View state
      const [viewMode, setViewMode] = useState('week');
      const [selectedQuarter, setSelectedQuarter] = useState(1);
      const [viewOffset, setViewOffset] = useState(() => {
        // Start at Today if current year matches default year (2026)
        const currentYear = new Date().getFullYear();
        const defaultYear = 2026;
        if (currentYear === defaultYear) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const rangeStart = new Date(defaultYear, 0, 1);
          rangeStart.setDate(rangeStart.getDate() - 60);
          return Math.max(0, Math.round((today - rangeStart) / (1000 * 60 * 60 * 24)));
        }
        return 60; // Default fallback (approx Jan 1) if not current year
      });
      const [collapsedLandscapes, setCollapsedLandscapes] = useState(new Set());
      const [collapsedSids, setCollapsedSids] = useState(new Set());
      const [collapsedActivities, setCollapsedActivities] = useState(new Set());
      const [editingSidInfo, setEditingSidInfo] = useState(null); // { landscapeId, sidId, notes }
      const [activityTypes, setActivityTypes] = useState(defaultActivityTypes);
      const [editingTypeId, setEditingTypeId] = useState(null);
      // Tab navigation
      const [activeTab, setActiveTab] = useState('gantt'); // 'gantt' or 'team'
      // Team members
      const [teamMembers, setTeamMembers] = useState([]);
      // Version
      const [appVersion, setAppVersion] = useState(APP_VERSION_FALLBACK);
      // Multi-User Locking
      const [myLocks, setMyLocks] = useState(new Set());
      // Online Users
      const [onlineUsers, setOnlineUsers] = useState([]);
      // Skills & Schulungen
      const [matrixColumns, setMatrixColumns] = useState([]);
      const [matrixValues, setMatrixValues] = useState([]);
      const [trainings, setTrainings] = useState([]);
      const [showCsvDropdown, setShowCsvDropdown] = useState(false);

      // Check permissions
      // canEdit: Admin OR Teamlead can edit landscapes, SIDs, activities
      const canEdit = user?.role === 'admin' || user?.role === 'teamlead';

      // canManageTeam: ONLY Teamlead can manage team members (add/delete/edit days)
      const canManageTeam = user?.role === 'teamlead';

      // Load data from API
      const loadData = useCallback(async () => {
        try {
          const [settings, types, lands, sundays, members, matrix, trns, initialUsers] = await Promise.all([
            api.getSettings(),
            api.getActivityTypes(),
            api.getLandscapes(),
            api.getMaintenanceSundays().catch(() => []),
            api.getTeamMembers().catch(() => []),
            api.getMatrix().catch(() => ({ columns: [], values: [] })),
            api.getTrainings().catch(() => []),
            api.getUsers().catch(() => [])
          ]);

          if (settings.year) setYear(parseInt(settings.year));
          if (settings.bundesland) setBundesland(settings.bundesland);
          const v = settings.version || (user && user.version) || APP_VERSION_FALLBACK;
          if (v) setAppVersion(v);
          if (types.length > 0) setActivityTypes(types);
          setTeamMembers(members);
          setMatrixColumns(matrix.columns || []);
          setMatrixValues(matrix.values || []);
          setTrainings(trns || []);
          if (initialUsers && initialUsers.length > 0) setUsers(initialUsers);

          // Calculate endDate for all activities and sub-activities on load
          const loadedYear = settings.year ? parseInt(settings.year) : new Date().getFullYear();
          const loadedBundesland = settings.bundesland || 'BW';
          const landsWithEndDates = lands.map(landscape => ({
            ...landscape,
            sids: landscape.sids.map(sid => ({
              ...sid,
              activities: sid.activities.map(activity => ({
                ...activity,
                teamMemberId: activity.teamMemberId || activity.team_member_id || null,
                endDate: calculateEndDate(
                  activity.startDate,
                  parseInt(activity.duration) || 1,
                  loadedYear,
                  loadedBundesland,
                  activity.includesWeekend || false
                ),
                subActivities: (activity.subActivities || []).map(sub => ({
                  ...sub,
                  teamMemberId: sub.teamMemberId || sub.team_member_id || null,
                  endDate: calculateEndDate(
                    sub.startDate,
                    parseInt(sub.duration) || 1,
                    loadedYear,
                    loadedBundesland,
                    sub.includesWeekend || false
                  )
                }))
              }))
            }))
          }));
          setLandscapes(landsWithEndDates);
          // Collapse all SIDs by default on load
          const allSidIds = new Set();
          landsWithEndDates.forEach(l => l.sids.forEach(s => allSidIds.add(s.id)));
          setCollapsedSids(allSidIds);
          setMaintenanceSundays(sundays);
        } catch (error) {
          if (error.message === 'SESSION_EXPIRED') {
            setUser(null);
          } else {
            console.error('Error loading data:', error);
          }
        }
      }, []);

      const handleRefresh = async () => {
        setLoading(true);
        await loadData();
        setLoading(false);
      };

      // Heartbeat for locks
      useEffect(() => {
        if (myLocks.size === 0) return;

        const interval = setInterval(async () => {
          for (const landscapeId of myLocks) {
            try {
              await api.acquireLock(landscapeId);
            } catch (err) {
              console.warn(`Failed to renew lock for landscape ${landscapeId}:`, err);
              // If lock lost, remove from myLocks to stop trying
              setMyLocks(prev => {
                const newSet = new Set(prev);
                newSet.delete(landscapeId);
                return newSet;
              });
            }
          }
        }, 1000 * 60 * 4); // Every 4 minutes

        return () => clearInterval(interval);
      }, [myLocks]);

      // Online Users tracking heartbeat
      useEffect(() => {
        if (!user) return; // Only if logged in

        const trackOnline = async () => {
          try {
            await api.ping();
            const users = await api.getOnlineUsers();
            setOnlineUsers(users);
          } catch (err) {
            console.warn('Online tracking failed', err);
          }
        };

        trackOnline(); // Initial call
        const interval = setInterval(trackOnline, 30000); // Poll every 30 seconds

        return () => clearInterval(interval);
      }, [user]);

      // Check authentication on mount
      useEffect(() => {
        const checkAuth = async () => {
          try {
            const userData = await api.getMe();
            setUser(userData);
            if (userData.version) setAppVersion(userData.version);
            // Apply user's dark mode preference from server
            applyDarkMode(!!userData.dark_mode);
            // Check if user must change password
            if (userData.must_change_password) {
              setMustChangePassword(true);
            } else {
              await loadData();
            }
          } catch {
            // Not logged in or session expired
            api.setToken(null);
          }
          setLoading(false);
        };
        checkAuth();
      }, [loadData, applyDarkMode]);



      // Login handler
      const handleLogin = async (e) => {
        e.preventDefault();
        const form = e.target;
        const username = form.username.value;
        const password = form.password.value;

        try {
          setLoginError('');
          const userData = await api.login(username, password);
          setUser(userData);
          if (userData.version) setAppVersion(userData.version);
          // Apply user's dark mode preference from server
          applyDarkMode(!!userData.dark_mode);
          // Check if user must change password on first login
          if (userData.must_change_password) {
            setMustChangePassword(true);
          } else {
            await loadData();
          }
        } catch (error) {
          setLoginError(error.message);
        }
      };

      // Logout handler
      const handleLogout = async () => {
        await api.logout();
        setUser(null);
        setLandscapes([]);
      };

      // Password change dialog state
      const [showPasswordDialog, setShowPasswordDialog] = useState(false);
      const [passwordError, setPasswordError] = useState('');
      const [passwordSuccess, setPasswordSuccess] = useState('');

      // Password change handler
      const handlePasswordChange = async (e) => {
        e.preventDefault();
        const form = e.target;
        const currentPassword = form.currentPassword.value;
        const newPassword = form.newPassword.value;
        const confirmPassword = form.confirmPassword.value;

        setPasswordError('');
        setPasswordSuccess('');

        if (newPassword !== confirmPassword) {
          setPasswordError('Die neuen Passw√∂rter stimmen nicht √ºberein');
          return;
        }

        try {
          await api.changePassword(currentPassword, newPassword);
          setPasswordSuccess('Passwort erfolgreich ge√§ndert!');
          form.reset();

          // If this was a forced password change, load app data and enter the app
          if (mustChangePassword) {
            setMustChangePassword(false);
            setTimeout(async () => {
              setPasswordSuccess('');
              await loadData();
            }, 1500);
          } else {
            setTimeout(() => {
              setShowPasswordDialog(false);
              setPasswordSuccess('');
            }, 2000);
          }
        } catch (error) {
          setPasswordError(error.message);
        }
      };

      // User management state
      const [showUserDialog, setShowUserDialog] = useState(false);
      const [users, setUsers] = useState([]);
      const [userError, setUserError] = useState('');
      const [editingUser, setEditingUser] = useState(null);
      const [resetPasswordUserId, setResetPasswordUserId] = useState(null);
      const [resetPasswordValue, setResetPasswordValue] = useState('');
      const [confirmDeleteUserId, setConfirmDeleteUserId] = useState(null);

      // Load users
      const loadUsers = async () => {
        try {
          const userList = await api.getUsers();
          setUsers(userList);
        } catch (error) {
          setUserError(error.message);
        }
      };

      // Open user dialog
      const openUserDialog = async () => {
        setShowUserDialog(true);
        setUserError('');
        setEditingUser(null);
        await loadUsers();
      };

      // Add new user
      const handleAddUser = async (e) => {
        e.preventDefault();
        const form = e.target;
        const username = form.newUsername.value.trim();
        const password = form.newPassword.value;
        const role = form.newRole.value;
        const first_name = form.newFirstName ? form.newFirstName.value.trim() : '';
        const last_name = form.newLastName ? form.newLastName.value.trim() : '';

        if (!username || !password || !first_name || !last_name) {
          setUserError('Benutzername, Passwort, Vorname und Nachname erforderlich');
          return;
        }

        try {
          setUserError('');
          await api.createUser({ username, password, role, first_name, last_name });
          form.reset();
          await loadUsers();
        } catch (error) {
          setUserError(error.message);
        }
      };

      // Delete user
      const handleDeleteUser = async (userId, username) => {
        if (userId === user.id) {
          setUserError('Sie k√∂nnen sich nicht selbst l√∂schen');
          return;
        }
        // Toggle inline confirmation
        if (confirmDeleteUserId === userId) {
          setConfirmDeleteUserId(null);
        } else {
          setConfirmDeleteUserId(userId);
          setUserError('');
        }
      };

      const confirmDeleteUser = async () => {
        try {
          await api.deleteUser(confirmDeleteUserId);
          setConfirmDeleteUserId(null);
          await loadUsers();
        } catch (error) {
          setUserError(error.message);
        }
      };

      // Reset user password - toggle inline input
      const handleResetPassword = (userId) => {
        if (resetPasswordUserId === userId) {
          // Toggle off if already open for this user
          setResetPasswordUserId(null);
          setResetPasswordValue('');
        } else {
          setResetPasswordUserId(userId);
          setResetPasswordValue('');
          setUserError('');
        }
      };

      // Submit the password reset
      const submitResetPassword = async () => {
        if (!resetPasswordValue || resetPasswordValue.length < 6) {
          setUserError('Passwort muss mindestens 6 Zeichen haben');
          return;
        }
        try {
          await api.updateUser(resetPasswordUserId, { password: resetPasswordValue });
          setResetPasswordUserId(null);
          setResetPasswordValue('');
          setUserError('');
          alert('Passwort wurde zur√ºckgesetzt');
        } catch (error) {
          setUserError(error.message);
        }
      };

      // =========================================
      // LOGS MANAGEMENT
      // =========================================
      const [showLogsDialog, setShowLogsDialog] = useState(false);
      const [logs, setLogs] = useState('');
      const [logsLoading, setLogsLoading] = useState(false);

      const openLogsDialog = async () => {
        setShowLogsDialog(true);
        setLogsLoading(true);
        try {
          const logData = await api.getLogs();
          setLogs(logData.logs || '');
        } catch (error) {
          console.error('Error loading logs:', error);
        }
        setLogsLoading(false);
      };

      // =========================================
      // MAINTENANCE SUNDAYS MANAGEMENT
      // =========================================
      const [showMaintenanceDialog, setShowMaintenanceDialog] = useState(false);
      const [maintenanceSundays, setMaintenanceSundays] = useState([]);
      const [maintenanceLoading, setMaintenanceLoading] = useState(false);
      const [addSkillDialog, setAddSkillDialog] = useState({ isOpen: false, name: '' });
      const [copySidDialog, setCopySidDialog] = useState({ isOpen: false, sourceSidId: null, sourceLandscapeId: null, targetLandscapeId: '', newName: '' });
      const [deleteConfirm, setDeleteConfirm] = useState({ isOpen: false, title: '', message: '', onConfirm: null });

      // Load maintenance sundays with other data
      const loadMaintenanceSundays = async () => {
        try {
          const sundays = await api.getMaintenanceSundays();
          setMaintenanceSundays(sundays);
        } catch (error) {
          console.error('Error loading maintenance sundays:', error);
        }
      };

      const openMaintenanceDialog = async () => {
        setShowMaintenanceDialog(true);
        setMaintenanceLoading(true);
        await loadMaintenanceSundays();
        setMaintenanceLoading(false);
      };

      const handleMaintenanceSundayUpdate = async (id, date) => {
        try {
          const existing = maintenanceSundays.find(s => s.id === id);
          await api.updateMaintenanceSunday(id, date, existing?.label || `Wartungssonntag ${['I', 'II', 'III', 'IV'][id - 1]}`);
          await loadMaintenanceSundays();
        } catch (error) {
          alert('Fehler beim Speichern: ' + error.message);
        }
      };

      // Toggle collapse state for a single landscape
      const toggleLandscapeCollapse = (landscapeId) => {
        setCollapsedLandscapes(prev => {
          const newSet = new Set(prev);
          if (newSet.has(landscapeId)) {
            newSet.delete(landscapeId);
          } else {
            newSet.add(landscapeId);
          }
          return newSet;
        });
      };

      const toggleSidCollapse = (sidId) => {
        setCollapsedSids(prev => {
          const newSet = new Set(prev);
          if (newSet.has(sidId)) {
            newSet.delete(sidId);
          } else {
            newSet.add(sidId);
          }
          return newSet;
        });
      };

      // Collapse all landscapes
      const collapseAllLandscapes = () => {
        setCollapsedLandscapes(new Set(landscapes.map(l => l.id)));
      };

      // Expand all landscapes
      const expandAllLandscapes = () => {
        setCollapsedLandscapes(new Set());
      };

      // Add new activity type
      const addActivityType = async () => {
        if (!canEdit) return;
        const newId = `custom_${Date.now()}`;
        const usedColors = activityTypes.map(t => t.color);
        const availableColor = availableColors.find(c => !usedColors.includes(c)) || '#6b7280';
        try {
          const newType = await api.createActivityType({ id: newId, label: 'Neue Aktivit√§t', color: availableColor });
          setActivityTypes([...activityTypes, newType]);
          setEditingTypeId(newId);
        } catch (error) {
          alert('Fehler: ' + error.message);
        }
      };

      // Rename activity type
      const renameActivityType = async (typeId, newLabel) => {
        if (!canEdit) return;
        try {
          await api.updateActivityType(typeId, { label: newLabel });
          setActivityTypes(activityTypes.map(t => t.id === typeId ? { ...t, label: newLabel } : t));
        } catch (error) {
          alert('Fehler: ' + error.message);
        }
      };

      // Delete activity type
      const deleteActivityType = async (typeId) => {
        if (!canEdit) return;
        if (activityTypes.length <= 1) {
          alert('Es muss mindestens ein Aktivit√§tstyp vorhanden sein.');
          return;
        }
        if (confirm('Aktivit√§tstyp wirklich l√∂schen?')) {
          try {
            await api.deleteActivityType(typeId);
            setActivityTypes(activityTypes.filter(t => t.id !== typeId));
          } catch (error) {
            alert('Fehler: ' + error.message);
          }
        }
      };

      // Memoized holidays
      const holidays = useMemo(() => getGermanHolidays(year, bundesland), [year, bundesland]);

      // Get today's date string using proper ISO format
      const todayDate = new Date();
      const today = formatDateISO(todayDate);
      const currentYear = todayDate.getFullYear();

      // =========================================================================
      // DATA MANAGEMENT (API-based)
      // =========================================================================

      const saveSettings = async () => {
        if (!canEdit) return;
        try {
          await api.updateSettings({ year, bundesland });
          alert('Einstellungen gespeichert!');
        } catch (error) {
          alert('Fehler: ' + error.message);
        }
      };

      const addLandscape = async () => {
        if (!canEdit) return;
        try {
          const newLandscape = await api.createLandscape(`Neue Landschaft ${landscapes.length + 1}`);
          setLandscapes([...landscapes, newLandscape]);
        } catch (error) {
          alert('Fehler: ' + error.message);
        }
      };

      const deleteLandscape = async (landscapeId) => {
        if (!canEdit) return;
        setDeleteConfirm({
          isOpen: true,
          title: 'Systemlandschaft l√∂schen',
          message: 'Systemlandschaft wirklich l√∂schen?',
          onConfirm: async () => {
            try {
              await api.deleteLandscape(landscapeId);
              setLandscapes(landscapes.filter(l => l.id !== landscapeId));
            } catch (error) {
              alert('Fehler: ' + error.message);
            }
          }
        });
      };

      const updateLandscape = async (landscapeId, field, value) => {
        if (!canEdit) return;
        try {
          const payload = { [field]: value };
          if (field === 'sort_order') {
            payload.sort_order = parseInt(value) || 0;
          }
          await api.updateLandscape(landscapeId, payload);

          // Reload all landscapes after sort_order change to see collision resolution
          if (field === 'sort_order') {
            const data = await api.getLandscapes();
            setLandscapes(data);
          } else {
            setLandscapes(prev => prev.map(l => l.id === landscapeId ? { ...l, [field]: value } : l));
          }
        } catch (error) {
          alert('Fehler: ' + error.message);
        }
      };

      const addSID = async (landscapeId) => {
        if (!canEdit) return;
        try {
          const newSid = await api.createSid(landscapeId, '', false);
          setLandscapes(landscapes.map(l =>
            l.id === landscapeId ? { ...l, sids: [...l.sids, newSid] } : l
          ));
        } catch (error) {
          alert('Fehler: ' + error.message);
        }
      };

      const deleteSID = async (landscapeId, sidId) => {
        if (!canEdit) return;
        setDeleteConfirm({
          isOpen: true,
          title: 'SID l√∂schen',
          message: 'SID wirklich l√∂schen?',
          onConfirm: async () => {
            try {
              await api.deleteSid(sidId);
              setLandscapes(landscapes.map(l =>
                l.id === landscapeId ? { ...l, sids: l.sids.filter(s => s.id !== sidId) } : l
              ));
            } catch (error) {
              alert('Fehler: ' + error.message);
            }
          }
        });
      };

      const updateSID = async (landscapeId, sidId, field, value) => {
        // visibleInGantt is allowed for ALL users (uses separate endpoint)
        if (field === 'visibleInGantt') {
          try {
            await api.toggleSidVisibility(sidId, value);
            setLandscapes(landscapes.map(l =>
              l.id === landscapeId ? {
                ...l,
                sids: l.sids.map(s => s.id !== sidId ? s : { ...s, [field]: value })
              } : l
            ));
          } catch (error) {
            alert('Fehler: ' + error.message);
          }
          return;
        }
        if (!canEdit) return;
        const apiFieldMap = { 'isPRD': 'is_prd', 'visibleInGantt': 'visible_in_gantt' };
        const apiField = apiFieldMap[field] || field;
        try {
          await api.updateSid(sidId, { [apiField]: value });
          setLandscapes(landscapes.map(l =>
            l.id === landscapeId ? {
              ...l,
              sids: l.sids.map(s => s.id !== sidId ? s : { ...s, [field]: value })
            } : l
          ));
        } catch (error) {
          alert('Fehler: ' + error.message);
        }
      };

      const handleCopySid = async () => {
        try {
          if (!copySidDialog.targetLandscapeId || !copySidDialog.newName) return;
          await api.copySid(copySidDialog.sourceSidId, copySidDialog.targetLandscapeId, copySidDialog.newName);
          setCopySidDialog({ isOpen: false, sourceSidId: null, sourceLandscapeId: null, targetLandscapeId: '', newName: '' });
          await loadData();
        } catch (error) {
          alert(error.message);
        }
      };

      const addActivity = async (landscapeId, sidId) => {
        if (!canEdit) return;
        const startDate = new Date().toISOString().split('T')[0];
        try {
          const newActivity = await api.createActivity({
            sid_id: sidId,
            type_id: 'installation',
            start_date: startDate,
            duration: 1,
            includes_weekend: false
          });
          newActivity.endDate = calculateEndDate(startDate, 1, year, bundesland, false);

          setLandscapes(landscapes.map(l =>
            l.id === landscapeId ? {
              ...l,
              sids: l.sids.map(s =>
                s.id === sidId ? { ...s, activities: [...s.activities, newActivity] } : s
              )
            } : l
          ));
        } catch (error) {
          alert('Fehler: ' + error.message);
        }
      };

      const deleteActivity = async (landscapeId, sidId, activityId) => {
        if (!canEdit) return;
        setDeleteConfirm({
          isOpen: true,
          title: 'Aktivit√§t l√∂schen',
          message: 'Aktivit√§t wirklich l√∂schen?',
          onConfirm: async () => {
            try {
              await api.deleteActivity(activityId);
              setLandscapes(landscapes.map(l =>
                l.id === landscapeId ? {
                  ...l,
                  sids: l.sids.map(s =>
                    s.id === sidId ? { ...s, activities: s.activities.filter(a => a.id !== activityId) } : s
                  )
                } : l
              ));
            } catch (error) {
              alert('Fehler: ' + error.message);
            }
          }
        });
      };

      const updateActivity = async (landscapeId, sidId, activityId, field, value) => {
        if (!canEdit) return;
        if (field === 'teamMemberId' && value) value = parseInt(value, 10);
        const apiFieldMap = { type: 'type_id', startDate: 'start_date', includesWeekend: 'includes_weekend', teamMemberId: 'team_member_id' };
        const apiField = apiFieldMap[field] || field;

        try {
          // If duration changes to > 1, also clear time fields
          const updatePayload = { [apiField]: value };
          if (field === 'duration' && parseInt(value) > 1) {
            updatePayload.start_time = null;
            updatePayload.end_time = null;
          }
          await api.updateActivity(activityId, updatePayload);

          setLandscapes(landscapes.map(l =>
            l.id === landscapeId ? {
              ...l,
              sids: l.sids.map(s =>
                s.id === sidId ? {
                  ...s,
                  activities: s.activities.map(a => {
                    if (a.id === activityId) {
                      const updated = { ...a, [field]: value };
                      if (field === 'startDate' || field === 'duration' || field === 'includesWeekend') {
                        const startDateVal = field === 'startDate' ? value : a.startDate;
                        const durationVal = field === 'duration' ? parseInt(value) || 1 : parseInt(a.duration) || 1;
                        const includesWE = field === 'includesWeekend' ? value : (a.includesWeekend || false);
                        updated.endDate = calculateEndDate(startDateVal, durationVal, year, bundesland, includesWE);
                        updated.duration = durationVal;
                        // Clear time fields if duration > 1
                        if (durationVal > 1) {
                          updated.start_time = null;
                          updated.end_time = null;
                        }
                      }
                      return updated;
                    }
                    return a;
                  })
                } : s
              )
            } : l
          ));
        } catch (error) {
          alert('Fehler: ' + error.message);
        }
      };

      // =========================================================================
      // SUB-ACTIVITY FUNCTIONS
      // =========================================================================

      const toggleActivityCollapse = (activityId) => {
        setCollapsedActivities(prev => {
          const newSet = new Set(prev);
          if (newSet.has(activityId)) {
            newSet.delete(activityId);
          } else {
            newSet.add(activityId);
          }
          return newSet;
        });
      };

      const addSubActivity = async (landscapeId, sidId, activityId) => {
        if (!canEdit) return;
        try {
          // Find the parent activity to get its start date as default
          const landscape = landscapes.find(l => l.id === landscapeId);
          const sid = landscape?.sids.find(s => s.id === sidId);
          const activity = sid?.activities.find(a => a.id === activityId);

          const startDate = activity?.startDate || formatDateISO(new Date());

          const newSubActivity = await api.createSubActivity({
            activity_id: activityId,
            name: 'Sub-Aktivit√§t',
            start_date: startDate,
            duration: 1,
            includes_weekend: false
          });
          newSubActivity.endDate = calculateEndDate(startDate, 1, year, bundesland, false);

          setLandscapes(landscapes.map(l =>
            l.id === landscapeId ? {
              ...l,
              sids: l.sids.map(s =>
                s.id === sidId ? {
                  ...s,
                  activities: s.activities.map(a =>
                    a.id === activityId ? {
                      ...a,
                      subActivities: [...(a.subActivities || []), newSubActivity]
                    } : a
                  )
                } : s
              )
            } : l
          ));
        } catch (error) {
          alert('Fehler: ' + error.message);
        }
      };

      const updateSubActivity = async (landscapeId, sidId, activityId, subActivityId, field, value) => {
        if (!canEdit) return;
        if (field === 'teamMemberId' && value) value = parseInt(value, 10);
        const apiFieldMap = { name: 'name', startDate: 'start_date', includesWeekend: 'includes_weekend', teamMemberId: 'team_member_id' };
        const apiField = apiFieldMap[field] || field;

        try {
          // If duration changes to > 1, also clear time fields
          const updatePayload = { [apiField]: value };
          if (field === 'duration' && parseInt(value) > 1) {
            updatePayload.start_time = null;
            updatePayload.end_time = null;
          }
          await api.updateSubActivity(subActivityId, updatePayload);

          setLandscapes(landscapes.map(l =>
            l.id === landscapeId ? {
              ...l,
              sids: l.sids.map(s =>
                s.id === sidId ? {
                  ...s,
                  activities: s.activities.map(a =>
                    a.id === activityId ? {
                      ...a,
                      subActivities: (a.subActivities || []).map(sub => {
                        if (sub.id === subActivityId) {
                          const updated = { ...sub, [field]: value };
                          if (field === 'startDate' || field === 'duration' || field === 'includesWeekend') {
                            const startDateVal = field === 'startDate' ? value : sub.startDate;
                            const durationVal = field === 'duration' ? parseInt(value) || 1 : parseInt(sub.duration) || 1;
                            const includesWE = field === 'includesWeekend' ? value : (sub.includesWeekend || false);
                            updated.endDate = calculateEndDate(startDateVal, durationVal, year, bundesland, includesWE);
                            updated.duration = durationVal;
                            // Clear time fields if duration > 1
                            if (durationVal > 1) {
                              updated.start_time = null;
                              updated.end_time = null;
                            }
                          }
                          return updated;
                        }
                        return sub;
                      })
                    } : a
                  )
                } : s
              )
            } : l
          ));
        } catch (error) {
          alert('Fehler: ' + error.message);
        }
      };

      const deleteSubActivity = async (landscapeId, sidId, activityId, subActivityId) => {
        if (!canEdit) return;
        setDeleteConfirm({
          isOpen: true,
          title: 'Sub-Aktivit√§t l√∂schen',
          message: 'Sub-Aktivit√§t wirklich l√∂schen?',
          onConfirm: async () => {
            try {
              await api.deleteSubActivity(subActivityId);
              setLandscapes(landscapes.map(l =>
                l.id === landscapeId ? {
                  ...l,
                  sids: l.sids.map(s =>
                    s.id === sidId ? {
                      ...s,
                      activities: s.activities.map(a =>
                        a.id === activityId ? {
                          ...a,
                          subActivities: (a.subActivities || []).filter(sub => sub.id !== subActivityId)
                        } : a
                      )
                    } : s
                  )
                } : l
              ));
            } catch (error) {
              alert('Fehler: ' + error.message);
            }
          }
        });
      };

      // =========================================================================
      // EXPORT/IMPORT FUNCTIONS  
      // =========================================================================

      const exportJSON = () => {
        try {
          const dataObj = { year, bundesland, landscapes, activityTypes };
          const dataStr = JSON.stringify(dataObj, null, 2);
          const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `sap-basis-planung-${year}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(url), 100);
        } catch (err) {
          alert('Fehler beim Export: ' + err.message);
        }
      };

      const exportCSV = () => {
        try {
          const BOM = '\ufeff';
          const now = new Date();
          const timestamp = now.getFullYear().toString()
            + String(now.getMonth() + 1).padStart(2, '0')
            + String(now.getDate()).padStart(2, '0')
            + '-'
            + String(now.getHours()).padStart(2, '0')
            + String(now.getMinutes()).padStart(2, '0')
            + String(now.getSeconds()).padStart(2, '0');
          const lines = ['Systemlandschaft;SID;PRD;Aktivit√§tstyp;Sub-Aktivit√§t;Startdatum;Dauer (Arbeitstage);Enddatum;Startzeit;Endzeit'];

          landscapes.forEach(landscape => {
            landscape.sids.filter(sid => sid.visibleInGantt !== false).forEach(sid => {
              if (sid.activities.length === 0) {
                lines.push(`${landscape.name};${sid.name};${sid.isPRD ? 'Ja' : 'Nein'};;;;;;;`);
              } else {
                sid.activities.forEach(activity => {
                  const actType = activityTypes.find(t => t.id === activity.type);
                  const actLabel = actType?.label || activity.type;

                  // Check if activity has sub-activities
                  if (activity.subActivities && activity.subActivities.length > 0) {
                    // Export each sub-activity as a separate row
                    activity.subActivities.forEach(subActivity => {
                      lines.push(`${landscape.name};${sid.name};${sid.isPRD ? 'Ja' : 'Nein'};${actLabel};${subActivity.name};${formatDateDE(subActivity.startDate)};${subActivity.duration};${formatDateDE(subActivity.endDate)};${subActivity.start_time || ''};${subActivity.end_time || ''}`);
                    });
                  } else {
                    // Export activity without sub-activities
                    lines.push(`${landscape.name};${sid.name};${sid.isPRD ? 'Ja' : 'Nein'};${actLabel};;${formatDateDE(activity.startDate)};${activity.duration};${formatDateDE(activity.endDate)};${activity.start_time || ''};${activity.end_time || ''}`);
                  }
                });
              }
            });
          });

          const csvContent = BOM + lines.join('\r\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `SAP-Basis-Planung-${year}-${timestamp}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(url), 100);
        } catch (err) {
          alert('Fehler beim CSV Export: ' + err.message);
        }
      };

      const exportTeamCSV = () => {
        try {
          const BOM = '\ufeff';
          const now = new Date();
          const timestamp = now.getFullYear().toString()
            + String(now.getMonth() + 1).padStart(2, '0')
            + String(now.getDate()).padStart(2, '0')
            + '-'
            + String(now.getHours()).padStart(2, '0')
            + String(now.getMinutes()).padStart(2, '0')
            + String(now.getSeconds()).padStart(2, '0');

          const lines = ['Teammitglied;K√ºrzel;Arbeitstage;Schulungen;Verplant Q1;Verplant Q2;Verplant Q3;Verplant Q4;Verplante Tage;Verf√ºgbare Tage'];

          teamMembers.forEach(member => {
            let totalDays = 0;
            const quarterDays = [0, 0, 0, 0];
            landscapes.forEach(landscape => {
              landscape.sids.forEach(sid => {
                sid.activities.forEach(activity => {
                  const getQuarter = (item) => {
                    const sd = item.startDate || item.start_date;
                    if (sd) {
                      const month = new Date(sd).getMonth();
                      return Math.floor(month / 3);
                    }
                    return -1;
                  };
                  const actMemberId = activity.teamMemberId || activity.team_member_id;
                  if (actMemberId === member.id) {
                    if (!activity.subActivities || activity.subActivities.length === 0) {
                      const dur = parseInt(activity.duration) || 0;
                      totalDays += dur;
                      const q = getQuarter(activity);
                      if (q >= 0) quarterDays[q] += dur;
                    }
                  }
                  (activity.subActivities || []).forEach(sub => {
                    const subMemberId = sub.teamMemberId || sub.team_member_id;
                    if (subMemberId === member.id) {
                      const dur = parseInt(sub.duration) || 0;
                      totalDays += dur;
                      const q = getQuarter(sub);
                      if (q >= 0) quarterDays[q] += dur;
                    }
                  });
                });
              });
            });

            const availableDays = (member.working_days || 0) - (member.training_days || 0) - totalDays;
            lines.push(`${member.name};${member.abbreviation};${member.working_days || 0};${member.training_days || 0};${quarterDays[0]};${quarterDays[1]};${quarterDays[2]};${quarterDays[3]};${totalDays};${availableDays}`);
          });

          const csvContent = BOM + lines.join('\r\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `SAP-Basis-Ressourcen-${year}-${timestamp}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(url), 100);
        } catch (err) {
          alert('Fehler beim Team CSV Export: ' + err.message);
        }
      };

      const exportSkillsCSV = () => {
        try {
          const BOM = '\ufeff';
          const now = new Date();
          const timestamp = now.getFullYear().toString()
            + String(now.getMonth() + 1).padStart(2, '0')
            + String(now.getDate()).padStart(2, '0')
            + '-'
            + String(now.getHours()).padStart(2, '0')
            + String(now.getMinutes()).padStart(2, '0')
            + String(now.getSeconds()).padStart(2, '0');

          const lines = [];

          // Section 1: Skill Matrix
          lines.push('=== Skill-Matrix ===');
          const skillHeaders = ['Teammitglied', ...matrixColumns.map(c => c.name), 'Gesamt'];
          lines.push(skillHeaders.join(';'));

          teamMembers.forEach(member => {
            let total = 0;
            const ratings = matrixColumns.map(col => {
              const val = matrixValues.find(v => v.team_member_id === member.id && v.column_id === col.id);
              const level = val ? val.level : 0;
              total += level;
              return level;
            });
            lines.push([member.name, ...ratings, total].join(';'));
          });

          // Section 2: Schulungen
          lines.push('');
          lines.push('=== Schulungen ===');
          lines.push('Teilnehmer;Kurs;Thema;Kosten;Ort;Termin 1;Termin 2;Termin 3;Tage;Gebucht');

          trainings.forEach(tr => {
            lines.push([
              tr.participants || '',
              tr.course || '',
              tr.topic || '',
              tr.cost || '',
              tr.location || '',
              tr.date1 || '',
              tr.date2 || '',
              tr.date3 || '',
              tr.days || '',
              tr.booked_date > 0 ? 'Ja' : 'Nein'
            ].join(';'));
          });

          const csvContent = BOM + lines.join('\r\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `SAP-Basis-Skills-${year}-${timestamp}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(url), 100);
        } catch (err) {
          alert('Fehler beim Skills CSV Export: ' + err.message);
        }
      };

      const importJSON = async (event) => {
        if (!canEdit) return;
        const file = event.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const text = e.target?.result;
            if (typeof text !== 'string') {
              throw new Error('Datei konnte nicht gelesen werden');
            }
            const data = JSON.parse(text);

            // Import via API
            await api.importJson(data);

            // Reload data from server
            await loadData();

            alert('Daten erfolgreich importiert!');
          } catch (err) {
            alert('Fehler beim Importieren: ' + err.message);
          }
        };
        reader.onerror = () => {
          alert('Fehler beim Lesen der Datei');
        };
        reader.readAsText(file, 'UTF-8');
        // Reset input so same file can be imported again
        event.target.value = '';
      };

      // =========================================================================
      // GANTT CHART RENDERING
      // =========================================================================

      const renderGanttChart = () => {
        const yearStart = new Date(year, 0, 1);
        const yearEnd = new Date(year, 11, 31);
        const totalDaysInYear = Math.ceil((yearEnd - yearStart) / (1000 * 60 * 60 * 24)) + 1;

        let allDays = [];
        let visibleDays = [];
        let headerCells = [];
        let dayWidth = 0;


        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0);
        const todayTime = todayDate.getTime();
        const todayStr = formatDateISO(todayDate);

        // Determine the base date range based on view mode
        let rangeStart, rangeEnd;

        if (viewMode === 'year') {
          rangeStart = yearStart;
          rangeEnd = yearEnd;
        } else if (viewMode === 'week') {
          // Week view: 420 days total, starting 60 days before Jan 1 of the selected year
          rangeStart = new Date(year, 0, 1);
          rangeStart.setDate(rangeStart.getDate() - 60);
          rangeEnd = new Date(rangeStart);
          rangeEnd.setDate(rangeEnd.getDate() + 419); // 420 days total
        } else {
          // Quarter view: show selected quarter
          rangeStart = new Date(year, (selectedQuarter - 1) * 3, 1);
          rangeEnd = new Date(year, selectedQuarter * 3, 0);
        }

        // Calculate if today is in the current range
        const isTodayInRange = todayTime >= rangeStart.getTime() && todayTime <= rangeEnd.getTime();
        const todayOffset = isTodayInRange ? Math.max(0, Math.round((todayTime - rangeStart.getTime()) / (1000 * 60 * 60 * 24))) : 0;

        // Calculate all days in the range
        const rangeDays = Math.ceil((rangeEnd - rangeStart) / (1000 * 60 * 60 * 24)) + 1;
        for (let i = 0; i < rangeDays; i++) {
          const date = new Date(rangeStart);
          date.setDate(date.getDate() + i);
          allDays.push(date);
        }

        // Apply offset for navigation (slider/buttons)
        // For week/quarter view: show a window of days that slides across the range
        const daysToShow = 65; // Number of days visible at once
        const maxOffset = Math.max(0, allDays.length - daysToShow);
        const effectiveOffset = Math.min(viewOffset, maxOffset);
        const visibleCount = viewMode === 'year' ? allDays.length : Math.min(daysToShow, allDays.length - effectiveOffset);

        visibleDays = allDays.slice(effectiveOffset, effectiveOffset + visibleCount);
        dayWidth = 100 / visibleDays.length;

        // Build header cells based on view mode
        if (viewMode === 'year') {
          // Month headers for year view
          for (let m = 0; m < 12; m++) {
            const monthStart = new Date(year, m, 1);
            const monthEnd = new Date(year, m + 1, 0);

            // Find indices in visibleDays
            const startIdx = visibleDays.findIndex(d => formatDateISO(d) === formatDateISO(monthStart));
            const endIdx = visibleDays.findIndex(d => formatDateISO(d) === formatDateISO(monthEnd));

            if (startIdx >= 0 && endIdx >= 0) {
              const width = ((endIdx - startIdx + 1) / visibleDays.length) * 100;
              headerCells.push({
                label: monthStart.toLocaleDateString('de-DE', { month: 'short' }),
                width,
                startDay: startIdx
              });
            }
          }
        } else if (viewMode === 'quarter') {
          // Week headers for quarter view
          let weekProcessed = new Set();
          visibleDays.forEach((date, idx) => {
            const weekNum = getISOWeekNumber(date);
            const weekdayIdx = getWeekdayIndex(date);

            if (weekdayIdx === 0 || idx === 0) { // Monday or first day
              if (!weekProcessed.has(weekNum)) {
                weekProcessed.add(weekNum);
                // Count how many days in this week are visible
                let weekDayCount = 0;
                for (let i = idx; i < visibleDays.length && weekDayCount < 7; i++) {
                  if (getISOWeekNumber(visibleDays[i]) === weekNum) {
                    weekDayCount++;
                  } else {
                    break;
                  }
                }
                const width = (weekDayCount / visibleDays.length) * 100;
                headerCells.push({
                  label: `KW ${weekNum}`,
                  width,
                  startDay: idx
                });
              }
            }
          });
        } else if (viewMode === 'week') {
          // Individual day headers with weekday letters and day numbers
          let currentWeek = -1;
          visibleDays.forEach((date, idx) => {
            const weekNum = getISOWeekNumber(date);
            const weekdayIdx = getWeekdayIndex(date); // 0=Mon, 6=Sun
            const dayLetter = weekDayLetters[weekdayIdx];
            const dayNumber = date.getDate(); // Day of month (1-31)
            const isNewWeek = weekNum !== currentWeek;

            headerCells.push({
              label: dayLetter,
              dayNumber: dayNumber,
              weekNum: weekNum,
              width: dayWidth,
              startDay: idx,
              isNewWeek: isNewWeek,
              monthName: date.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' }) // Add month name with year
            });

            currentWeek = weekNum;
          });
        }

        // Use maxOffset for slider (already calculated above)
        const sliderMax = maxOffset;

        return (
          <div className="bg-white rounded-lg shadow-lg p-4 mb-6 overflow-hidden">
            <h2 className="text-xl font-bold mb-4">Gantt-Chart {year}</h2>

            {/* Navigation Controls */}
            <div className="flex items-center gap-2 mb-4 flex-wrap w-1/2">
              <button
                onClick={() => setViewOffset(Math.max(0, viewOffset - 7))}
                className="flex items-center gap-1 px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm"
                title="7 Tage zur√ºck"
              >
                <ChevronLeftIcon /> Woche
              </button>
              <button
                onClick={() => setViewOffset(Math.max(0, viewOffset - 1))}
                className="flex items-center gap-1 px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm"
                title="1 Tag zur√ºck"
              >
                <ChevronLeftIcon /> Tag
              </button>

              <input
                type="range"
                min="0"
                max={sliderMax}
                value={Math.min(viewOffset, sliderMax)}
                onChange={(e) => setViewOffset(parseInt(e.target.value))}
                className="flex-1 min-w-32"
                title={`Tag ${viewOffset + 1}`}
              />

              <button
                onClick={() => setViewOffset(Math.min(sliderMax, viewOffset + 1))}
                className="flex items-center gap-1 px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm"
                title="1 Tag vor"
              >
                Tag <ChevronRightIcon />
              </button>
              <button
                onClick={() => setViewOffset(Math.min(sliderMax, viewOffset + 7))}
                className="flex items-center gap-1 px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm"
                title="7 Tage vor"
              >
                Woche <ChevronRightIcon />
              </button>

              <button
                onClick={() => setViewOffset(todayOffset)}
                disabled={!isTodayInRange}
                className={`px-3 py-1 rounded text-sm transition-colors ${isTodayInRange
                  ? 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                  : 'bg-gray-100 text-gray-400 cursor-not-allowed opacity-60'
                  }`}
                title={isTodayInRange ? "Heute anzeigen" : "Heute liegt nicht im gew√§hlten Zeitraum"}
              >
                Heute
              </button>
            </div>

            <div className="min-w-max">
              {/* Header Row */}
              <div className="flex border-b-2 border-gray-300 mb-2">
                <div className="gantt-row-label min-w-48 font-semibold p-2 bg-gray-50">
                  Systemlandschaft / SID
                </div>
                <div className="flex-1 flex relative">
                  {viewMode === 'week' ? (
                    // Week view: three rows - KW on top, weekday letters middle, day numbers bottom
                    <div className="flex flex-col w-full">
                      {/* Row 1: Month Names (Dedicated Row) */}
                      <div className="flex w-full border-b border-gray-200">
                        {(() => {
                          const monthGroups = [];
                          let currentMonthStr = null;
                          let monthStartIdx = 0;

                          // Group days by Month
                          headerCells.forEach((cell, idx) => {
                            // headerCells are days in 'week' view mode
                            // We can use the monthName we already pre-calculated in cell
                            if (cell.monthName !== currentMonthStr) {
                              if (currentMonthStr !== null) {
                                monthGroups.push({
                                  monthName: currentMonthStr,
                                  count: idx - monthStartIdx
                                });
                              }
                              currentMonthStr = cell.monthName;
                              monthStartIdx = idx;
                            }
                          });
                          // Push last group
                          if (currentMonthStr !== null) {
                            monthGroups.push({
                              monthName: currentMonthStr,
                              count: headerCells.length - monthStartIdx
                            });
                          }

                          return monthGroups.map((mg, idx) => (
                            <div
                              key={idx}
                              className="relative h-6 bg-white border-l border-gray-300"
                              style={{ flex: mg.count, minWidth: `${mg.count * 20}px` }}
                            >
                              <span className="absolute left-0 top-0 pl-1 font-bold text-gray-800 text-xs whitespace-nowrap bg-white pr-2 z-10">
                                {mg.monthName}
                              </span>
                            </div>
                          ));
                        })()}
                      </div>

                      {/* Row 2: Week numbers (KW) */}
                      <div className="flex w-full">
                        {(() => {
                          // Group days by week number
                          const weekGroups = [];
                          let currentWeekNum = null;
                          let weekStartIdx = 0;
                          headerCells.forEach((cell, idx) => {
                            if (cell.weekNum !== currentWeekNum) {
                              if (currentWeekNum !== null) {
                                weekGroups.push({
                                  weekNum: currentWeekNum,
                                  count: idx - weekStartIdx
                                });
                              }
                              currentWeekNum = cell.weekNum;
                              weekStartIdx = idx;
                            }
                          });
                          if (currentWeekNum !== null) {
                            weekGroups.push({
                              weekNum: currentWeekNum,
                              count: headerCells.length - weekStartIdx
                            });
                          }
                          return weekGroups.map((wg, idx) => {
                            return (
                              <div
                                key={idx}
                                className="text-center text-[10px] text-blue-600 font-medium border-l border-blue-400 relative"
                                style={{ flex: wg.count, minWidth: `${wg.count * 20}px` }}
                              >
                                KW{wg.weekNum}
                              </div>
                            );
                          });
                        })()}
                      </div>
                      {/* Row 2: Weekday letters */}
                      <div className="flex w-full">
                        {headerCells.map((cell, idx) => (
                          <div
                            key={idx}
                            className={`text-center text-xs font-medium border-l border-gray-200 flex-1 ${cell.isNewWeek ? 'border-l border-blue-400' : ''}`}
                            style={{ minWidth: '20px' }}
                          >
                            {cell.label}
                          </div>
                        ))}
                      </div>
                      {/* Row 3: Day numbers */}
                      <div className="flex w-full">
                        {headerCells.map((cell, idx) => (
                          <div
                            key={idx}
                            className={`text-center text-[10px] text-gray-500 border-l border-gray-200 flex-1 ${cell.isNewWeek ? 'border-l border-blue-400' : ''}`}
                            style={{ minWidth: '20px' }}
                          >
                            {cell.dayNumber}
                          </div>
                        ))}
                      </div>
                    </div>
                  ) : (
                    // Year/Quarter view
                    headerCells.map((cell, idx) => (
                      <div
                        key={idx}
                        className="text-center text-sm font-medium border-l border-gray-200 px-1 py-2 whitespace-nowrap overflow-hidden text-ellipsis"
                        style={{ width: `${cell.width}%` }}
                      >
                        {cell.label}
                      </div>
                    ))
                  )}
                </div>
              </div>

              {/* Gantt Rows */}
              {landscapes.map(landscape => (
                <div key={landscape.id} className="mb-4">
                  <div className="font-semibold text-lg mb-1 text-blue-700 px-2">
                    {landscape.name}
                  </div>
                  {landscape.sids.filter(sid => sid.visibleInGantt !== false).map(sid => {
                    // Build a unified flat array of all renderables (normal activities AND subActivities)
                    const allRenderables = [];
                    sid.activities.forEach(act => {
                      if (act.type === 'update' && (act.subActivities || []).length > 0) {
                        (act.subActivities || []).forEach(sub => {
                          allRenderables.push({
                            ...sub,
                            isSub: true,
                            parentType: act.type,
                            endDate: sub.endDate || calculateEndDate(sub.startDate, sub.duration || 1, year, bundesland, sub.includesWeekend || false)
                          });
                        });
                      } else {
                        allRenderables.push({
                          ...act,
                          isSub: false,
                          endDate: act.endDate || calculateEndDate(act.startDate, act.duration || 1, year, bundesland, act.includesWeekend || false)
                        });
                      }
                    });

                    const checkOverlap = (a, b) => new Date(a.startDate) <= new Date(b.endDate) && new Date(b.startDate) <= new Date(a.endDate);
                    const assigned = [];
                    let maxLanes = 1;

                    // Sort by start date for a better left-to-right packing
                    allRenderables.sort((a, b) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime());

                    allRenderables.forEach(item => {
                      const usedLanes = new Set();
                      assigned.forEach(prev => { if (checkOverlap(prev, item)) usedLanes.add(prev.lane); });
                      let lane = 0;
                      while (usedLanes.has(lane)) lane++;
                      assigned.push({ ...item, lane });
                      maxLanes = Math.max(maxLanes, lane + 1);
                    });
                    if (assigned.length === 0) maxLanes = 1;

                    // Row height and bar sizing based on lanes
                    const barHeight = maxLanes === 1 ? 24 : maxLanes === 2 ? 20 : maxLanes === 3 ? 16 : 12;
                    const baseTop = 4;
                    const rowHeight = Math.max(40, baseTop + (maxLanes * (barHeight + 2)) + 4);

                    const darkenColor = (color, amt) => {
                      const hex = (color || '#3B82F6').replace('#', '');
                      const r = Math.max(0, parseInt(hex.substring(0, 2), 16) - amt);
                      const g = Math.max(0, parseInt(hex.substring(2, 4), 16) - amt);
                      const b = Math.max(0, parseInt(hex.substring(4, 6), 16) - amt);
                      return `rgb(${r}, ${g}, ${b})`;
                    };

                    return (
                      <div key={sid.id} className="flex items-stretch hover:bg-gray-50">
                        <div className={`gantt-row-label min-w-48 pl-4 text-sm flex items-center gap-1 py-1 border-b ${viewMode === 'year' ? 'border-gray-400' : 'border-gray-100'}`}>
                          <span className={sid.isPRD ? 'font-bold text-red-600' : ''}>
                            {sid.name || 'Neue SID'}
                          </span>
                          {sid.isPRD && <span className="text-xs bg-red-100 text-red-700 px-1 rounded">PRD</span>}
                        </div>
                        <div className={`flex-1 relative border-l border-gray-200 border-b ${viewMode === 'year' ? 'border-gray-400' : 'border-gray-100'}`} style={{ height: `${rowHeight}px` }}>
                          {/* Day cells with weekend/holiday indicators */}
                          <div className="absolute inset-0 flex">
                            {visibleDays.map((date, idx) => {
                              const dateStr = formatDateISO(date);
                              const isWE = isWeekend(date);
                              const isHoliday = holidays.has(dateStr);
                              const isMaintenanceSunday = maintenanceSundays.some(s => s.date === dateStr);
                              const isToday = dateStr === today && year === currentYear;

                              return (
                                <div
                                  key={idx}
                                  className={`
                                  h-full border-r border-gray-100
                                  ${isWE ? 'weekend-pattern' : ''}
                                  ${isHoliday ? 'holiday-pattern' : ''}
                                  ${isMaintenanceSunday ? 'maintenance-pattern' : ''}
                                  ${isToday ? 'today-marker' : ''}
                                `}
                                  style={{ width: `${dayWidth}%`, minWidth: viewMode === 'week' ? '20px' : '0' }}
                                  title={`${date.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' })}${isHoliday ? ' - ' + holidays.get(dateStr) : ''}${isMaintenanceSunday ? ' - Wartungssonntag' : ''}`}
                                />
                              );
                            })}
                          </div>

                          {/* Unified Activity bars render */}
                          {assigned.flatMap(item => {
                            const actType = activityTypes.find(t => t.id === (item.isSub ? item.parentType : item.type));
                            const baseColor = actType?.color || '#3B82F6';
                            const barColor = item.lane % 2 === 0 ? baseColor : darkenColor(baseColor, 40);
                            const topOffset = baseTop + (item.lane * (barHeight + 2));

                            const segments = getActivitySegments(item.startDate, item.endDate, item.includesWeekend || false, holidays);

                            const frame = (segments.length > 1 && !item.includesWeekend) ? (() => {
                              const startIdx = visibleDays.findIndex(d => formatDateISO(d) === formatDateISO(new Date(item.startDate)));
                              const endIdx = visibleDays.findIndex(d => formatDateISO(d) === formatDateISO(new Date(item.endDate)));

                              if (endIdx < 0 && startIdx < 0) return null;
                              if (startIdx >= 0 && startIdx >= visibleDays.length) return null;
                              if (endIdx >= 0 && endIdx < 0) return null;

                              const effStart = startIdx >= 0 ? startIdx : 0;
                              const effEnd = endIdx >= 0 ? endIdx : visibleDays.length - 1;
                              const lPct = (effStart / visibleDays.length) * 100;
                              const wPct = ((effEnd - effStart + 1) / visibleDays.length) * 100;

                              if (wPct <= 0) return null;

                              return (
                                <div
                                  key={`frame-${item.isSub ? 'sub-' : ''}${item.id}`}
                                  className="absolute rounded border border-solid pointer-events-none"
                                  style={{
                                    left: `${lPct}%`,
                                    width: `${wPct}%`,
                                    borderColor: item.isSub ? barColor : actType?.color,
                                    borderWidth: '1px',
                                    top: `${topOffset}px`,
                                    height: `${barHeight}px`,
                                    zIndex: 5
                                  }}
                                />
                              );
                            })() : null;

                            return [
                              frame,
                              ...segments.map((segment, segIdx) => {
                                const startIdx = visibleDays.findIndex(d => formatDateISO(d) === segment.start);
                                const endIdx = visibleDays.findIndex(d => formatDateISO(d) === segment.end);
                                if (endIdx < 0 && startIdx < 0) return null;
                                const effectiveStartIdx = startIdx >= 0 ? startIdx : 0;
                                const effectiveEndIdx = endIdx >= 0 ? endIdx : visibleDays.length - 1;
                                if (startIdx >= 0 && startIdx >= visibleDays.length) return null;
                                if (endIdx >= 0 && endIdx < 0) return null;
                                const leftPct = (effectiveStartIdx / visibleDays.length) * 100;
                                const widthPct = ((effectiveEndIdx - effectiveStartIdx + 1) / visibleDays.length) * 100;
                                if (widthPct <= 0) return null;
                                const isFirstSegment = segIdx === 0;

                                let titleStr = '';
                                if (item.isSub) {
                                  titleStr = `${item.name}: ${formatDateDE(item.startDate)} - ${formatDateDE(item.endDate)} (${item.duration} AT)${item.start_time && item.end_time ? ` (${item.start_time} - ${item.end_time})` : ''}${item.teamMemberId ? ` [${teamMembers.find(m => m.id === parseInt(item.teamMemberId))?.abbreviation || '?'}]` : ''}`;
                                } else {
                                  let teamInfo = '';
                                  if (item.teamMemberId) {
                                    const member = teamMembers.find(m => m.id === parseInt(item.teamMemberId));
                                    teamInfo = member ? ` [${member.abbreviation}]` : '';
                                  }
                                  const timeInfo = (item.start_time && item.end_time) ? ` (${item.start_time} - ${item.end_time})` : '';
                                  titleStr = `${actType?.label}: ${formatDateDE(item.startDate)} - ${formatDateDE(item.endDate)} (${item.duration} Arbeitstage)${timeInfo}${teamInfo}${segments.length > 1 ? ` [Teil ${segIdx + 1}/${segments.length}]` : ''}`;
                                }

                                const labelStr = item.isSub ? item.name : actType?.label;

                                return (
                                  <div
                                    key={`${item.isSub ? 'sub-' : ''}${item.id}-${segIdx}`}
                                    className="activity-bar absolute rounded text-xs text-white flex items-center justify-center cursor-pointer overflow-hidden"
                                    style={{
                                      left: `${leftPct}%`,
                                      width: `${Math.max(widthPct, 0.5)}%`,
                                      backgroundColor: item.isSub ? barColor : actType?.color,
                                      top: `${topOffset}px`,
                                      height: `${barHeight}px`,
                                      minWidth: '8px',
                                      zIndex: 10
                                    }}
                                    title={titleStr}
                                  >
                                    {(isFirstSegment || item.isSub) && <span className="truncate px-1" style={{ fontSize: maxLanes > 1 ? '8px' : '12px' }}>{labelStr}</span>}
                                  </div>
                                );
                              })
                            ];
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>
          </div>
        );
      };

      // =========================================================================
      // RENDER
      // =========================================================================

      // Loading state
      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex flex-col items-center justify-center">
            <div className="text-xl text-gray-600">Lade...</div>
            <div className="text-center text-gray-400 text-xs mt-8">
              SAP Basis Jahresplaner ‚Ä¢ Optima Solutions GmbH
            </div>
          </div>
        );
      }

      // Login form
      if (!user) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex flex-col items-center justify-center p-4">
            <div className="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
              <div className="flex items-center gap-3 mb-6">
                <CalendarIcon />
                <h1 className="text-2xl font-bold text-gray-800">SAP Basis Jahresplaner</h1>
              </div>

              <form onSubmit={handleLogin}>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Benutzername</label>
                  <input
                    type="text"
                    name="username"
                    required
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Benutzername"
                  />
                </div>

                <div className="mb-6">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Passwort</label>
                  <input
                    type="password"
                    name="password"
                    required
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Passwort"
                  />
                </div>

                {loginError && (
                  <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                    {loginError}
                  </div>
                )}

                <button
                  type="submit"
                  className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
                >
                  Anmelden
                </button>
              </form>
            </div>
            <div className="text-center text-gray-500 text-xs mt-8">
              SAP Basis Jahresplaner ‚Ä¢ {appVersion && `Version ${appVersion} ‚Ä¢ `}Optima Solutions GmbH
            </div>
          </div>
        );
      }

      // Forced password change screen (after login, before app access)
      if (user && mustChangePassword) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex flex-col items-center justify-center p-4">
            <div className="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
              <div className="flex items-center gap-3 mb-2">
                <span className="text-2xl">üîê</span>
                <h1 className="text-2xl font-bold text-gray-800">Passwort √§ndern</h1>
              </div>
              <p className="text-sm text-gray-500 mb-6">
                Willkommen, <strong>{user.username}</strong>! Bitte √§ndern Sie Ihr Passwort, bevor Sie die Anwendung verwenden k√∂nnen.
              </p>

              <form onSubmit={handlePasswordChange}>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Aktuelles Passwort</label>
                  <input
                    type="password"
                    name="currentPassword"
                    required
                    minLength="6"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="Initiales Passwort eingeben"
                  />
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Neues Passwort</label>
                  <input
                    type="password"
                    name="newPassword"
                    required
                    minLength="6"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="Mind. 6 Zeichen"
                  />
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Neues Passwort best√§tigen</label>
                  <input
                    type="password"
                    name="confirmPassword"
                    required
                    minLength="6"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="Neues Passwort wiederholen"
                  />
                </div>

                {passwordError && (
                  <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                    {passwordError}
                  </div>
                )}

                {passwordSuccess && (
                  <div className="mb-4 p-3 bg-green-100 text-green-700 rounded-lg text-sm">
                    {passwordSuccess}
                  </div>
                )}

                <button
                  type="submit"
                  className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
                >
                  Passwort √§ndern
                </button>
              </form>
            </div>
            <div className="text-center text-gray-500 text-xs mt-8">
              SAP Basis Jahresplaner ‚Ä¢ {appVersion && `Version ${appVersion} ‚Ä¢ `}Optima Solutions GmbH
            </div>
          </div>
        );
      }

      // Main application
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-6">
          {/* Online Users Sidebar */}
          {user && onlineUsers.length > 0 && (
            <div className="fixed right-4 top-24 z-40 max-h-[80vh] overflow-y-auto flex flex-col gap-2">
              {onlineUsers.map(u => (
                <div key={u.id} className="flex items-center gap-1 justify-center px-2 py-1 bg-gray-200 rounded border border-gray-300 text-sm font-medium" title={u.username}>
                  <span className="text-gray-600">üë§</span>
                  {u.abbreviation}
                </div>
              ))}
            </div>
          )}
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-6">
              <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                <div className="flex items-center gap-3">
                  <CalendarIcon />
                  <h1 className="text-2xl md:text-3xl font-bold text-gray-800">SAP Basis Jahresplaner</h1>
                </div>
                <div className="flex gap-2 flex-wrap header-controls items-center">
                  <span className="text-sm text-gray-600">
                    {user.username} ({user.role === 'teamlead' ? 'Teamleiter' : user.role === 'admin' ? 'Administrator' : user.role === 'viewer' ? 'Viewer' : 'Benutzer'})
                  </span>
                  <button onClick={() => setShowPasswordDialog(true)} className="px-3 py-1 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded">
                    üîë Passwort
                  </button>
                  {canEdit && (
                    <button onClick={openUserDialog} className="px-3 py-1 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded">
                      üë• Benutzer
                    </button>
                  )}
                  <button onClick={handleLogout} className="px-3 py-1 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded">
                    Abmelden
                  </button>
                  {canEdit && (
                    <button onClick={saveSettings} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                      <SaveIcon /> Einstellungen speichern
                    </button>
                  )}
                  <button onClick={handleRefresh} className="flex items-center gap-2 px-4 py-2 bg-blue-100 text-blue-700 border border-blue-300 rounded-lg hover:bg-blue-200 text-sm" title="Daten vom Server aktualisieren">
                    üîÑ Aktualisieren
                  </button>
                  {/* CSV Export Dropdown */}
                  <div className="relative" style={{ position: 'relative' }}>
                    <button
                      onClick={() => setShowCsvDropdown(!showCsvDropdown)}
                      className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm"
                    >
                      <DownloadIcon /> CSV Export ‚ñæ
                    </button>
                    {showCsvDropdown && (
                      <div className="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-xl z-50 min-w-48" style={{ zIndex: 9999 }}>
                        <button
                          onClick={() => { exportCSV(); setShowCsvDropdown(false); }}
                          className="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-emerald-50 hover:text-emerald-700 rounded-t-lg flex items-center gap-2"
                        >
                          üìä Gantt-Ansicht
                        </button>
                        {user?.role !== 'viewer' && (
                          <button
                            onClick={() => { exportSkillsCSV(); setShowCsvDropdown(false); }}
                            className="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-emerald-50 hover:text-emerald-700 flex items-center gap-2 border-t border-gray-100"
                          >
                            üéì Skills & Schulungen
                          </button>
                        )}
                        {(user?.role === 'admin' || user?.role === 'teamlead') && (
                          <button
                            onClick={() => { exportTeamCSV(); setShowCsvDropdown(false); }}
                            className="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-emerald-50 hover:text-emerald-700 rounded-b-lg flex items-center gap-2 border-t border-gray-100"
                          >
                            üë• Team-Auslastung
                          </button>
                        )}
                      </div>
                    )}
                  </div>
                  {/* Click-outside closes dropdown */}
                  {showCsvDropdown && (
                    <div
                      className="fixed inset-0"
                      style={{ zIndex: 9998 }}
                      onClick={() => setShowCsvDropdown(false)}
                    />
                  )}
                  {/* JSON Export/Import - Admin + Teamlead */}
                  {(user?.role === 'teamlead' || user?.role === 'admin') && (
                    <>
                      <button onClick={exportJSON} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                        <DownloadIcon /> JSON Export
                      </button>
                      <label className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 cursor-pointer text-sm">
                        <UploadIcon /> JSON Import
                        <input type="file" accept=".json,application/json" onChange={importJSON} className="hidden" />
                      </label>
                    </>
                  )}
                  {/* Backup Export/Import - Teamlead only */}
                  {user?.role === 'teamlead' && (
                    <>
                      <button
                        onClick={async () => {
                          try {
                            const backup = await api.exportBackup();
                            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `SAP-Planner-Backup-${new Date().toISOString().slice(0, 10)}.json`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            setTimeout(() => URL.revokeObjectURL(url), 100);
                          } catch (error) {
                            alert('‚ùå Fehler beim Backup: ' + error.message);
                          }
                        }}
                        className="flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 text-sm"
                      >
                        üì• Backup
                      </button>
                      <label className="flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 cursor-pointer text-sm">
                        üì§ Restore
                        <input type="file" accept=".json,application/json" onChange={async (event) => {
                          const file = event.target.files?.[0];
                          if (!file) return;
                          try {
                            const text = await file.text();
                            const backup = JSON.parse(text);
                            if (!backup.version) {
                              alert('‚ùå Ung√ºltige Backup-Datei: Version fehlt');
                              return;
                            }
                            const confirmed = confirm(
                              `Backup importieren?\n\n` +
                              `Backup-Version: ${backup.version}\n` +
                              `Export-Datum: ${backup.exportDate ? new Date(backup.exportDate).toLocaleString('de-DE') : 'unbekannt'}\n\n` +
                              `‚ö†Ô∏è Alle aktuellen Daten werden √ºberschrieben!`
                            );
                            if (confirmed) {
                              const result = await api.importBackup(backup);
                              alert(
                                `‚úÖ Backup erfolgreich importiert!\n\n` +
                                `Importierte Daten:\n` +
                                Object.entries(result.imported || {}).map(([k, v]) => `  ${k}: ${v}`).join('\n')
                              );
                              window.location.reload();
                            }
                          } catch (error) {
                            alert('‚ùå Fehler beim Import: ' + error.message);
                          }
                          event.target.value = '';
                        }} className="hidden" />
                      </label>
                    </>
                  )}
                  {/* Logfiles - Admin + Teamlead */}
                  {canEdit && (
                    <button onClick={openLogsDialog} className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">
                      üìã Logfiles
                    </button>
                  )}
                  <button
                    onClick={toggleDarkMode}
                    className="dark-toggle"
                    title={darkMode ? 'Heller Modus' : 'Dunkler Modus (Dracula)'}
                    aria-label={darkMode ? 'Switch to light mode' : 'Switch to dark mode'}
                  />
                </div>
              </div>

              {/* Settings */}
              <div className="flex gap-4 items-end flex-wrap">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Jahr</label>
                  <input
                    type="number"
                    value={year}
                    min="2026"
                    max="2036"
                    onChange={(e) => {
                      const val = parseInt(e.target.value);
                      if (val >= 2026 && val <= 2036) {
                        setYear(val);
                        setViewOffset(60); // Reset to Jan 1 of the new year
                      }
                    }}
                    disabled={!canEdit}
                    className={`px-4 py-2 border border-gray-300 rounded-lg w-24 ${!canEdit ? 'bg-gray-100' : ''}`}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Bundesland</label>
                  <select
                    value={bundesland}
                    onChange={(e) => setBundesland(e.target.value)}
                    disabled={!canEdit}
                    className={`px-4 py-2 border border-gray-300 rounded-lg ${!canEdit ? 'bg-gray-100 appearance-none' : ''}`}
                  >
                    {bundeslaender.map(bl => (
                      <option key={bl.id} value={bl.id}>{bl.name}</option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Ansicht</label>
                  <select
                    value={viewMode}
                    onChange={(e) => { setViewMode(e.target.value); setViewOffset(0); }}
                    className="px-4 py-2 border border-gray-300 rounded-lg"
                  >
                    <option value="year">Jahresansicht</option>
                    <option value="quarter">Quartalsansicht</option>
                    <option value="week">Kalenderwoche</option>
                  </select>
                </div>

                {(viewMode === 'quarter' || viewMode === 'week') && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Quartal</label>
                    <select
                      value={selectedQuarter}
                      onChange={(e) => { setSelectedQuarter(parseInt(e.target.value)); setViewOffset(0); }}
                      className="px-4 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value={1}>Q1 (Jan-M√§r)</option>
                      <option value={2}>Q2 (Apr-Jun)</option>
                      <option value={3}>Q3 (Jul-Sep)</option>
                      <option value={4}>Q4 (Okt-Dez)</option>
                    </select>
                  </div>
                )}

                {/* Wartungssonntag Selector */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Wartungssonntag</label>
                  <div className="flex gap-2">
                    <select
                      className="px-4 py-2 border border-gray-300 rounded-lg bg-purple-50"
                      defaultValue=""
                      onChange={(e) => {
                        const selectedId = parseInt(e.target.value);
                        const selected = maintenanceSundays.find(s => s.id === selectedId);
                        if (!selected || !selected.date) return;

                        // Ensure week view mode for offset-based navigation
                        if (viewMode !== 'week') setViewMode('week');

                        // Calculate offset: rangeStart is 60 days before today
                        // Calculate offset: rangeStart is 60 days before Jan 1 of selected year
                        const rangeStart = new Date(year, 0, 1);
                        rangeStart.setDate(rangeStart.getDate() - 60);
                        const targetDate = new Date(selected.date);
                        const dayIndex = Math.round((targetDate - rangeStart) / (1000 * 60 * 60 * 24));
                        const daysToShow = 65;
                        const totalDays = 420;
                        const centerOffset = Math.max(0, Math.min(totalDays - daysToShow, dayIndex - Math.floor(daysToShow / 2)));
                        setViewOffset(centerOffset);
                      }}
                    >
                      <option value="" disabled>Ausw√§hlen...</option>
                      {maintenanceSundays.filter(s => s.date).map(s => (
                        <option key={s.id} value={s.id}>
                          {['I', 'II', 'III', 'IV'][s.id - 1]} - {formatDateDE(s.date)}
                        </option>
                      ))}
                    </select>
                    {canEdit && (
                      <button
                        onClick={openMaintenanceDialog}
                        className="px-3 py-2 text-purple-700 border border-purple-300 rounded-lg hover:bg-purple-50 text-sm"
                        title="Wartungssonntage bearbeiten"
                      >
                        ‚öôÔ∏è
                      </button>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* Tab Navigation */}
            <div className="flex gap-2 mb-6">
              <button
                onClick={() => setActiveTab('gantt')}
                className={`px-6 py-3 rounded-lg font-medium transition-colors ${activeTab === 'gantt'
                  ? 'bg-blue-600 text-white'
                  : 'bg-white text-gray-600 hover:bg-gray-100'
                  }`}
              >
                üìä Gantt-Ansicht
              </button>
              {canEdit && (
                <button
                  onClick={() => setActiveTab('team')}
                  className={`px-6 py-3 rounded-lg font-medium transition-colors ${activeTab === 'team'
                    ? 'bg-blue-600 text-white'
                    : 'bg-white text-gray-600 hover:bg-gray-100'
                    }`}
                >
                  üë• Team-Auslastung
                </button>
              )}
              {user?.role !== 'viewer' && (
                <button
                  onClick={() => setActiveTab('skills')}
                  className={`px-6 py-3 rounded-lg font-medium transition-colors ${activeTab === 'skills'
                    ? 'bg-blue-600 text-white'
                    : 'bg-white text-gray-600 hover:bg-gray-100'
                    }`}
                >
                  üéì Skills & Schulungen
                </button>
              )}
            </div>

            {/* Legend - visible only when Gantt tab is active */}
            <div className="bg-white rounded-lg shadow-lg p-4 mb-6" style={{ display: activeTab === 'gantt' ? 'block' : 'none' }}>
              <div className="flex items-center gap-3 mb-2">
                <h3 className="font-semibold">Aktivit√§tstypen:</h3>
                {canEdit && (
                  <button
                    onClick={addActivityType}
                    className="text-sm px-2 py-1 border border-gray-300 rounded hover:bg-gray-100"
                  >
                    + Aktivit√§t hinzuf√ºgen
                  </button>
                )}
              </div>
              <div className="flex flex-wrap gap-3">
                {activityTypes.map(type => (
                  <div key={type.id} className="flex items-center gap-2 group">
                    <div className="w-4 h-4 rounded" style={{ backgroundColor: type.color }}></div>
                    {canEdit && editingTypeId === type.id ? (
                      <input
                        type="text"
                        value={type.label}
                        onChange={(e) => renameActivityType(type.id, e.target.value)}
                        onBlur={() => setEditingTypeId(null)}
                        onKeyDown={(e) => e.key === 'Enter' && setEditingTypeId(null)}
                        className="text-sm px-1 border border-blue-400 rounded w-32"
                        autoFocus
                        maxLength="24"
                      />
                    ) : (
                      <span
                        className={`text-sm ${canEdit ? 'cursor-pointer hover:text-blue-600' : ''}`}
                        onClick={() => canEdit && setEditingTypeId(type.id)}
                        title={canEdit ? 'Klicken zum Umbenennen' : ''}
                      >
                        {type.label}
                      </span>
                    )}
                    {canEdit && (
                      <button
                        onClick={() => deleteActivityType(type.id)}
                        className="opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 text-xs"
                        title="L√∂schen"
                      >
                        √ó
                      </button>
                    )}
                  </div>
                ))}
              </div>
              <div className="flex flex-wrap gap-4 mt-3 pt-3 border-t border-gray-200">
                <div className="flex items-center gap-2 mr-4 font-bold text-gray-700">
                  Zeichenschl√ºssel:
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 weekend-pattern border border-gray-300"></div>
                  <span className="text-sm">Wochenende</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 holiday-pattern border border-gray-300"></div>
                  <span className="text-sm">Feiertag</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 today-marker border border-gray-300"></div>
                  <span className="text-sm">Heute ({formatDateDE(today)})</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 maintenance-pattern border border-purple-400"></div>
                  <span className="text-sm">Wartungssonntag</span>
                </div>
                <div className="flex items-center gap-2 ml-4">
                  <div className="relative h-6 w-24 flex items-center">
                    <div className="absolute inset-x-0 top-1 bottom-1 border border-pink-500 rounded z-0"></div>
                    <div className="absolute left-0 top-1 bottom-1 w-3 bg-pink-500 rounded-l z-10 text-[8px] text-white flex items-center justify-center">S..</div>
                    <div className="absolute left-3 right-8 top-1 bottom-1 weekend-pattern opacity-50 z-0"></div>
                    <div className="absolute right-0 top-1 bottom-1 w-8 bg-pink-500 rounded-r z-10"></div>
                  </div>
                  <span className="text-sm">Zusammenh√§ngende Aktivit√§t</span>
                </div>
              </div>
            </div>

            {/* Gantt Chart */}
            <div style={{ display: activeTab === 'gantt' ? 'block' : 'none' }}>
              {renderGanttChart()}
            </div>

            {/* Data Entry Section */}
            <div className="bg-white rounded-lg shadow-lg p-4 md:p-6" style={{ display: activeTab === 'gantt' ? 'block' : 'none' }}>
              <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                <div className="flex items-center gap-4">
                  <h2 className="text-xl font-bold">Systemlandschaften & SIDs</h2>
                  <button
                    onClick={expandAllLandscapes}
                    className="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 text-sm"
                  >
                    + Alle Aufklappen
                  </button>
                  <button
                    onClick={collapseAllLandscapes}
                    className="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 text-sm"
                  >
                    - Alle Zuklappen
                  </button>
                </div>
                {canEdit && (
                  <button
                    onClick={addLandscape}
                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    <PlusIcon /> Landschaft hinzuf√ºgen
                  </button>
                )}
              </div>

              {landscapes.map(landscape => {
                const isLockedByOther = landscape.lock && landscape.lock.user_id !== (user?.id);
                // We show lock indicator and disable all inputs if locked by other

                return (
                  <div key={landscape.id} className={`mb-6 border rounded-lg p-4 ${isLockedByOther ? 'border-red-300 bg-red-50/10 shadow-inner' : 'border-gray-200 shadow-sm'}`}>
                    <div className="flex items-center justify-between mb-3 flex-wrap gap-2">
                      <div className="flex items-center gap-3">
                        {isLockedByOther && (
                          <div className="flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold animate-pulse">
                            <span>üîí Gesperrt durch {landscape.lock.username}</span>
                          </div>
                        )}
                        {/* Sort Order Input */}
                        <div className="relative">
                          <input
                            type="number"
                            defaultValue={landscape.sort_order || 0}
                            key={`sort-${landscape.id}-${landscape.sort_order}`}
                            disabled={!canEdit || isLockedByOther}
                            min="0"
                            max="99"
                            onBlur={(e) => {
                              const val = e.target.value.replace(/[^0-9]/g, '');
                              if (val !== String(landscape.sort_order || 0)) {
                                updateLandscape(landscape.id, 'sort_order', val);
                              }
                            }}
                            className={`w-8 h-8 text-center font-bold text-white rounded focus:ring-2 focus:ring-offset-1 focus:ring-blue-500 bg-blue-600 ${(!canEdit || isLockedByOther) ? 'cursor-default opacity-50' : 'cursor-text'}`}
                          />
                        </div>

                        <input
                          type="text"
                          value={landscape.name}
                          onChange={(e) => updateLandscape(landscape.id, 'name', e.target.value)}
                          disabled={!canEdit || isLockedByOther}
                          maxLength={35}
                          className={`text-lg font-bold px-2 py-1 border-b-2 border-blue-600 bg-transparent text-blue-700 ${(!canEdit || isLockedByOther) ? 'cursor-default' : ''}`}
                        />
                        <button
                          onClick={() => toggleLandscapeCollapse(landscape.id)}
                          className="px-3 py-1 border border-purple-300 text-purple-700 rounded hover:bg-purple-50 text-sm"
                        >
                          {collapsedLandscapes.has(landscape.id) ? '+ Aufklappen' : '- Zuklappen'}
                        </button>
                      </div>
                      {canEdit && !isLockedByOther && (
                        <div className="flex gap-2">
                          <button
                            onClick={() => addSID(landscape.id)}
                            className="flex items-center gap-2 px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                          >
                            <PlusIcon /> SID hinzuf√ºgen
                          </button>
                          <button
                            onClick={() => deleteLandscape(landscape.id)}
                            className="flex items-center justify-center w-8 h-8 bg-red-100 text-red-700 rounded hover:bg-red-200"
                            title="Landschaft l√∂schen"
                          >
                            <TrashIcon />
                          </button>
                        </div>
                      )}
                    </div>

                    {!collapsedLandscapes.has(landscape.id) && landscape.sids.sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0)).map(sid => (
                      <div key={sid.id} className="ml-0 md:ml-4 mb-4 border-l-4 border-blue-300 pl-4">
                        <div className="flex items-center gap-3 mb-2 flex-wrap">
                          {/* SID Sort Order Input */}
                          <div className="relative">
                            <input
                              type="number"
                              defaultValue={sid.sort_order || 0}
                              key={`sid-sort-${sid.id}-${sid.sort_order}`}
                              disabled={!canEdit || isLockedByOther}
                              min="0"
                              max="999"
                              onBlur={(e) => {
                                const val = e.target.value.replace(/[^0-9]/g, '');
                                if (val !== String(sid.sort_order || 0)) {
                                  updateSID(landscape.id, sid.id, 'sort_order', val);
                                }
                              }}
                              className={`w-8 h-8 text-center font-bold text-blue-700 bg-blue-100 border border-blue-300 rounded focus:ring-2 focus:ring-offset-1 focus:ring-blue-500 ${(!canEdit || isLockedByOther) ? 'cursor-default opacity-50' : 'cursor-text dark-mode:bg-blue-800/30'}`}
                              title="Sortierung (je kleiner, desto weiter oben)"
                            />
                          </div>

                          <input
                            type="text"
                            value={sid.name}
                            placeholder="SID Name"
                            onChange={(e) => {
                              const val = e.target.value.toUpperCase().replace(/[^A-Z0-9_\-]/g, '').substring(0, 8);
                              updateSID(landscape.id, sid.id, 'name', val);
                            }}
                            maxLength={8}
                            disabled={!canEdit || isLockedByOther}
                            className={`px-2 py-1 border border-gray-300 rounded font-medium w-24 ${(!canEdit || isLockedByOther) ? 'bg-gray-100' : ''}`}
                          />
                          <label className="flex items-center gap-2 text-sm">
                            <input
                              type="checkbox"
                              checked={sid.isPRD || false}
                              onChange={(e) => updateSID(landscape.id, sid.id, 'isPRD', e.target.checked)}
                              disabled={!canEdit || isLockedByOther}
                              className="w-4 h-4"
                            />
                            <span className={sid.isPRD ? 'text-red-600 font-bold' : ''}>PRD System</span>
                          </label>
                          <label className="flex items-center gap-2 text-sm ml-4 border-l pl-4 border-gray-300">
                            <input
                              type="checkbox"
                              checked={sid.visibleInGantt !== false}
                              onChange={(e) => updateSID(landscape.id, sid.id, 'visibleInGantt', e.target.checked)}
                              disabled={isLockedByOther}
                              className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                            />
                            <span>Sichtbar in Gantt</span>
                          </label>
                          {canEdit && !isLockedByOther && (
                            <button
                              onClick={() => addActivity(landscape.id, sid.id)}
                              className="flex items-center gap-1 px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm"
                            >
                              <PlusIcon /> Aktivit√§t
                            </button>
                          )}
                          {canEdit && !isLockedByOther && (
                            <button
                              onClick={() => setEditingSidInfo({ landscapeId: landscape.id, sidId: sid.id, notes: sid.notes || '' })}
                              className="flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 border border-blue-300 rounded hover:bg-blue-200 text-sm"
                            >
                              SID Info
                            </button>
                          )}
                          <button
                            onClick={() => toggleSidCollapse(sid.id)}
                            className="px-2 py-1 border border-purple-300 text-purple-700 bg-white rounded hover:bg-purple-50 text-sm"
                          >
                            {collapsedSids.has(sid.id) ? '+ Aufklappen' : '- Zuklappen'}
                          </button>
                          <div className="flex gap-2 ml-auto">
                            {canEdit && !isLockedByOther && (
                              <button
                                onClick={() => setCopySidDialog({
                                  isOpen: true,
                                  sourceSidId: sid.id,
                                  sourceLandscapeId: landscape.id,
                                  targetLandscapeId: landscape.id, // Default to same landscape
                                  newName: `${sid.name}_COPY`
                                })}
                                className="p-1.5 text-blue-600 hover:bg-blue-50 rounded"
                                title="SID kopieren"
                              >
                                <DocumentDuplicateIcon />
                              </button>
                            )}
                            {canEdit && !isLockedByOther && (
                              <button
                                onClick={() => deleteSID(landscape.id, sid.id)}
                                className="flex items-center justify-center w-8 h-8 bg-red-100 text-red-700 rounded hover:bg-red-200"
                              >
                                <TrashIcon />
                              </button>
                            )}
                          </div>
                        </div>

                        {!collapsedSids.has(sid.id) && sid.activities.map(activity => {
                          const actType = activityTypes.find(t => t.id === activity.type);
                          const hasSubActivities = activity.type === 'update' && (activity.subActivities || []).length > 0;
                          const subActivityTeamMembers = hasSubActivities ? [...new Set((activity.subActivities || []).map(s => s.teamMemberId).filter(id => id))] : [];
                          const isSingleUserAcrossSubs = subActivityTeamMembers.length === 1;
                          const singleUserAbbr = isSingleUserAcrossSubs ? teamMembers.find(m => String(m.id) === String(subActivityTeamMembers[0]))?.abbreviation : null;
                          const totalSubDuration = hasSubActivities
                            ? (activity.subActivities || []).reduce((sum, sub) => sum + (parseInt(sub.duration) || 1), 0)
                            : (parseInt(activity.duration) || 1);

                          let displayStartDate = activity.startDate;
                          let displayEndDate = activity.endDate;
                          if (hasSubActivities) {
                            const subDates = activity.subActivities.map(sub => sub.startDate).filter(d => d).sort();
                            const subEndDates = activity.subActivities.map(sub => sub.endDate).filter(d => d).sort();
                            if (subDates.length > 0) displayStartDate = subDates[0];
                            if (subEndDates.length > 0) displayEndDate = subEndDates[subEndDates.length - 1];
                          }

                          return (
                            <div key={activity.id} className="ml-0 md:ml-4 mb-2 pl-3 py-3 pr-1 bg-gray-50 rounded">
                              <div className="flex flex-wrap gap-2 items-center justify-between w-full">
                                <div className="flex flex-wrap gap-2 items-center flex-grow">
                                  <div className="w-3 h-3 rounded-full" style={{ backgroundColor: actType?.color }} />
                                  <select
                                    value={activity.type}
                                    onChange={(e) => updateActivity(landscape.id, sid.id, activity.id, 'type', e.target.value)}
                                    disabled={!canEdit || isLockedByOther}
                                    className={`px-2 py-1 border border-gray-300 rounded text-sm ${(!canEdit || isLockedByOther) ? 'bg-gray-100' : ''}`}
                                  >
                                    {activityTypes.map(type => (
                                      <option key={type.id} value={type.id}>{type.label}</option>
                                    ))}
                                  </select>
                                  <div className="flex items-center gap-1">
                                    <span className="text-sm text-gray-600">Start:</span>
                                    {hasSubActivities ? (
                                      <span className="px-2 py-1 bg-purple-100 text-purple-700 border border-purple-300 rounded text-sm">{formatDateDE(displayStartDate)}</span>
                                    ) : (
                                      <input
                                        type="date"
                                        value={activity.startDate}
                                        onChange={(e) => updateActivity(landscape.id, sid.id, activity.id, 'startDate', e.target.value)}
                                        disabled={!canEdit || isLockedByOther}
                                        className={`px-2 py-1 border border-gray-300 rounded text-sm ${(!canEdit || isLockedByOther) ? 'bg-gray-100' : ''}`}
                                      />
                                    )}
                                  </div>
                                  <div className="flex items-center gap-1">
                                    <span className="text-sm text-gray-600">Dauer:</span>
                                    {hasSubActivities ? (
                                      <span className="px-2 py-1 bg-purple-100 text-purple-700 border border-purple-300 rounded text-sm font-medium">Œ£ {totalSubDuration}</span>
                                    ) : (
                                      <input
                                        type="number"
                                        value={activity.duration}
                                        onChange={(e) => updateActivity(landscape.id, sid.id, activity.id, 'duration', parseInt(e.target.value) || 1)}
                                        disabled={!canEdit || isLockedByOther}
                                        className={`px-2 py-1 border border-gray-300 rounded w-16 text-sm ${(!canEdit || isLockedByOther) ? 'bg-gray-100' : ''}`}
                                      />
                                    )}
                                  </div>
                                  <div className="text-sm text-gray-600">Ende: <span className="font-medium">{formatDateDE(displayEndDate)}</span></div>
                                  <label className="flex items-center gap-1 text-sm ml-4">
                                    <input
                                      type="checkbox"
                                      checked={activity.includesWeekend || false}
                                      onChange={(e) => updateActivity(landscape.id, sid.id, activity.id, 'includesWeekend', e.target.checked)}
                                      disabled={!canEdit || isLockedByOther}
                                      className="w-4 h-4"
                                    />
                                    <span className="font-medium">WE</span>
                                  </label>
                                </div>
                                <div className="flex items-center gap-2 ml-auto pl-2 border-l border-gray-200">
                                  <div className="flex items-center gap-1 w-[110px] justify-center">
                                    <span className="text-sm text-gray-600">üë§</span>
                                    {hasSubActivities ? (
                                      <span className="text-sm font-medium px-2 py-0.5 bg-gray-200 rounded border border-gray-300">
                                        {subActivityTeamMembers.length === 0 ? '-' : (isSingleUserAcrossSubs && singleUserAbbr ? singleUserAbbr : 'Multi')}
                                      </span>
                                    ) : (!canEdit || isLockedByOther) ? (
                                      <span className="px-2 py-1 border border-gray-300 rounded text-sm w-full bg-gray-50 text-gray-700 min-h-[28px] flex items-center">
                                        {activity.teamMemberId ? (teamMembers.find(m => m.id === parseInt(activity.teamMemberId))?.abbreviation || '-') : '-'}
                                      </span>
                                    ) : (
                                      <select
                                        value={activity.teamMemberId || ''}
                                        onChange={(e) => updateActivity(landscape.id, sid.id, activity.id, 'teamMemberId', e.target.value || null)}
                                        disabled={isLockedByOther}
                                        className="px-2 py-1 border border-gray-300 rounded text-sm w-full"
                                      >
                                        <option value="">-</option>
                                        {teamMembers.map(member => <option key={member.id} value={member.id}>{member.abbreviation}</option>)}
                                      </select>
                                    )}
                                  </div>
                                  {canEdit && !isLockedByOther && (
                                    <button onClick={() => deleteActivity(landscape.id, sid.id, activity.id)} className="flex items-center justify-center w-8 h-8 bg-red-100 text-red-700 rounded hover:bg-red-200">
                                      <TrashIcon />
                                    </button>
                                  )}
                                </div>
                              </div>
                              {activity.type === 'update' && canEdit && !isLockedByOther && (
                                <div className="flex items-center gap-2 mt-2 ml-4">
                                  <button onClick={() => addSubActivity(landscape.id, sid.id, activity.id)} className="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 border border-purple-300 rounded hover:bg-purple-200">
                                    + Sub-Aktivit√§t
                                  </button>
                                </div>
                              )}
                              {activity.type === 'update' && (activity.subActivities || []).map(subActivity => (
                                <div key={subActivity.id} className="ml-6 mt-2 pl-2 py-2 pr-1 bg-white border-l-2 rounded" style={{ borderColor: actType?.color }}>
                                  <div className="flex flex-wrap gap-2 items-center justify-between w-full">
                                    <div className="flex flex-wrap gap-2 items-center flex-grow">
                                      <input
                                        type="text"
                                        value={subActivity.name}
                                        onChange={(e) => updateSubActivity(landscape.id, sid.id, activity.id, subActivity.id, 'name', e.target.value)}
                                        disabled={!canEdit || isLockedByOther}
                                        className={`px-2 py-1 border border-gray-300 rounded text-sm w-32 ${(!canEdit || isLockedByOther) ? 'bg-gray-100' : ''}`}
                                      />
                                      <div className="flex items-center gap-1">
                                        <span className="text-sm text-gray-600">Start:</span>
                                        <input
                                          type="date"
                                          value={subActivity.startDate}
                                          onChange={(e) => updateSubActivity(landscape.id, sid.id, activity.id, subActivity.id, 'startDate', e.target.value)}
                                          disabled={!canEdit || isLockedByOther}
                                          className={`px-1 py-0.5 border border-gray-300 rounded text-xs ${(!canEdit || isLockedByOther) ? 'bg-gray-100' : ''}`}
                                        />
                                      </div>
                                      <div className="flex items-center gap-1">
                                        <span className="text-sm text-gray-600">Dauer:</span>
                                        <input
                                          type="number"
                                          value={subActivity.duration}
                                          onChange={(e) => updateSubActivity(landscape.id, sid.id, activity.id, subActivity.id, 'duration', parseInt(e.target.value) || 1)}
                                          disabled={!canEdit || isLockedByOther}
                                          className={`px-1 py-0.5 border border-gray-300 rounded w-12 text-xs ${(!canEdit || isLockedByOther) ? 'bg-gray-100' : ''}`}
                                        />
                                      </div>
                                      <div className="flex items-center gap-1">
                                        <span className="text-sm text-gray-600">Ende:</span>
                                        <span className="font-medium text-sm w-20">{subActivity.endDate ? formatDateDE(subActivity.endDate) : '-'}</span>
                                      </div>
                                      <label className="flex items-center gap-1 text-sm text-gray-600 cursor-pointer">
                                        <input
                                          type="checkbox"
                                          checked={subActivity.includesWeekend}
                                          onChange={(e) => updateSubActivity(landscape.id, sid.id, activity.id, subActivity.id, 'includesWeekend', e.target.checked)}
                                          disabled={!canEdit || isLockedByOther}
                                          className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        />
                                        WE
                                      </label>
                                    </div>
                                    <div className="flex items-center gap-2 ml-auto pl-2 border-l border-gray-200">
                                      <div className="flex items-center gap-1 w-[110px] justify-center">
                                        <span className="text-sm text-gray-600">üë§</span>
                                        {(!canEdit || isLockedByOther) ? (
                                          <span className="px-2 py-1 border border-gray-300 rounded text-sm w-full bg-gray-50 text-gray-700 min-h-[28px] flex items-center">
                                            {subActivity.teamMemberId ? (teamMembers.find(m => m.id === parseInt(subActivity.teamMemberId))?.abbreviation || '-') : '-'}
                                          </span>
                                        ) : (
                                          <select
                                            value={subActivity.teamMemberId || ''}
                                            onChange={(e) => updateSubActivity(landscape.id, sid.id, activity.id, subActivity.id, 'teamMemberId', e.target.value || null)}
                                            disabled={isLockedByOther}
                                            className="px-2 py-1 border border-gray-300 rounded text-sm w-full"
                                          >
                                            <option value="">-</option>
                                            {teamMembers.map(member => <option key={member.id} value={member.id}>{member.abbreviation}</option>)}
                                          </select>
                                        )}
                                      </div>
                                      {canEdit && !isLockedByOther && (
                                        <button onClick={() => deleteSubActivity(landscape.id, sid.id, activity.id, subActivity.id)} className="w-6 h-6 bg-red-50 text-red-600 rounded flex items-center justify-center"><TrashIcon /></button>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          );
                        })}
                      </div>
                    ))}
                  </div>
                );
              })}
            </div >
          </div >

          {/* Team-Auslastung Tab */}
          {
            activeTab === 'team' && (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6 max-w-7xl mx-auto">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-gray-800">üë• Team-Auslastung</h2>

                </div>

                {/* Team Members Section */}
                <div className="mb-8">
                  <h3 className="text-lg font-semibold text-gray-700 mb-4">Teammitglieder verwalten</h3>

                  {/* Add Team Member Form */}
                  {/* Add Team Member Form - Only for Teamlead */}
                  {canManageTeam && (
                    <form
                      onSubmit={async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        const userId = form.userId.value;
                        if (userId) {
                          try {
                            const newMember = await api.createTeamMember({ user_id: userId });
                            setTeamMembers([...teamMembers, newMember]);
                            form.reset();
                          } catch (error) {
                            alert(error.message);
                          }
                        }
                      }}
                      className="flex gap-3 mb-4 items-end"
                    >
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <select
                          name="userId"
                          required
                          className="px-4 py-2 border border-gray-300 rounded-lg w-64 bg-white"
                        >
                          <option value="">- Bitte w√§hlen -</option>
                          {users && users.filter(u => u.role !== 'viewer').map(u => {
                            const displayName = (u.first_name || u.last_name) ? `${u.first_name} ${u.last_name}`.trim() : u.username;
                            return (
                              <option key={u.id} value={u.id}>{displayName}</option>
                            );
                          })}
                        </select>
                      </div>
                      <button
                        type="submit"
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
                      >
                        + Hinzuf√ºgen
                      </button>
                    </form>
                  )}

                  {/* Team Members Table */}
                  <table className="w-full border-collapse">
                    <thead>
                      <tr className="bg-gray-100">
                        <th className="text-left p-3 font-semibold">Teammitglied</th>
                        <th className="text-left p-3 font-semibold">K√ºrzel</th>
                        {canManageTeam && <th className="text-center p-3 font-semibold">Arbeitstage</th>}
                        {canManageTeam && <th className="text-center p-3 font-semibold">Schulungen</th>}
                        {canManageTeam && <th className="text-center p-3 font-semibold">Verplant Q1</th>}
                        {canManageTeam && <th className="text-center p-3 font-semibold">Verplant Q2</th>}
                        {canManageTeam && <th className="text-center p-3 font-semibold">Verplant Q3</th>}
                        {canManageTeam && <th className="text-center p-3 font-semibold">Verplant Q4</th>}
                        <th className="text-right p-3 font-semibold">Verplante Tage</th>
                        <th className="text-center p-3 font-semibold">Verf√ºgbare Tage</th>
                        {canManageTeam && <th className="text-right p-3 font-semibold">Aktionen</th>}
                      </tr>
                    </thead>
                    <tbody>
                      {teamMembers.map(member => {
                        // Calculate total days for this team member
                        let totalDays = 0;
                        const quarterDays = [0, 0, 0, 0]; // Q1, Q2, Q3, Q4
                        landscapes.forEach(landscape => {
                          landscape.sids.forEach(sid => {
                            sid.activities.forEach(activity => {
                              const getQuarter = (item) => {
                                const sd = item.startDate || item.start_date;
                                if (sd) {
                                  const month = new Date(sd).getMonth(); // 0-11
                                  return Math.floor(month / 3); // 0-3
                                }
                                return -1;
                              };
                              const actMemberId = activity.teamMemberId || activity.team_member_id;
                              if (actMemberId === member.id) {
                                if (!activity.subActivities || activity.subActivities.length === 0) {
                                  const sd = activity.startDate || activity.start_date;
                                  if (sd && new Date(sd).getFullYear() === year) {
                                    const dur = parseInt(activity.duration) || 0;
                                    totalDays += dur;
                                    const q = getQuarter(activity);
                                    if (q >= 0) quarterDays[q] += dur;
                                  }
                                }
                              }
                              (activity.subActivities || []).forEach(sub => {
                                const subMemberId = sub.teamMemberId || sub.team_member_id;
                                if (subMemberId === member.id) {
                                  const sd = sub.startDate || sub.start_date;
                                  if (sd && new Date(sd).getFullYear() === year) {
                                    const dur = parseInt(sub.duration) || 0;
                                    totalDays += dur;
                                    const q = getQuarter(sub);
                                    if (q >= 0) quarterDays[q] += dur;
                                  }
                                }
                              });
                            });
                          });
                        });

                        return (
                          <tr key={member.id} className="border-b border-gray-200 hover:bg-gray-50">
                            <td className="p-3">{member.name}</td>
                            <td className="p-3 font-mono font-bold text-blue-600">{member.abbreviation}</td>
                            {canManageTeam && (
                              <td className="p-3 text-center">
                                <input
                                  type="number"
                                  value={member.working_days || 0}
                                  onChange={async (e) => {
                                    const val = Math.min(260, Math.max(0, parseInt(e.target.value) || 0));
                                    try {
                                      await api.updateTeamMember(member.id, { working_days: val });
                                      setTeamMembers(prev => prev.map(m => m.id === member.id ? { ...m, working_days: val } : m));
                                    } catch (err) { alert(err.message); }
                                  }}
                                  className="w-16 text-center border border-gray-300 rounded px-1 py-0.5"
                                  max="260"
                                />
                              </td>
                            )}
                            {canManageTeam && (
                              <td className="p-3 text-center">
                                {/* Training days are now calculated dynamically from the Trainings Matrix ONLY IF BOOKED */}
                                <span className="font-semibold text-gray-700">
                                  {trainings.filter(t => t.booked_date > 0 && t.participants && (t.participants.includes(member.name) || t.participants.includes(member.abbreviation))).reduce((sum, t) => sum + (parseInt(t.days) || 0), 0)}
                                </span>
                              </td>
                            )}
                            {canManageTeam && <td className="p-3 text-center">{quarterDays[0]}</td>}
                            {canManageTeam && <td className="p-3 text-center">{quarterDays[1]}</td>}
                            {canManageTeam && <td className="p-3 text-center">{quarterDays[2]}</td>}
                            {canManageTeam && <td className="p-3 text-center">{quarterDays[3]}</td>}
                            <td className="p-3 text-right font-semibold">{totalDays + trainings.filter(t => t.booked_date > 0 && t.participants && (t.participants.includes(member.name) || t.participants.includes(member.abbreviation))).reduce((sum, t) => sum + (parseInt(t.days) || 0), 0)} Tage</td>
                            <td className="p-3 text-center font-bold">
                              <span>
                                {(member.working_days || 0)
                                  - trainings.filter(t => t.booked_date > 0 && t.participants && (t.participants.includes(member.name) || t.participants.includes(member.abbreviation))).reduce((sum, t) => sum + (parseInt(t.days) || 0), 0)
                                  - totalDays}
                              </span>
                            </td>
                            {canManageTeam && (
                              <td className="p-3 text-right">
                                <button
                                  onClick={async () => {
                                    setDeleteConfirm({
                                      isOpen: true,
                                      title: 'Teammitglied l√∂schen',
                                      message: `"${member.name}" wirklich l√∂schen?`,
                                      onConfirm: async () => {
                                        try {
                                          await api.deleteTeamMember(member.id);
                                          setTeamMembers(teamMembers.filter(m => m.id !== member.id));
                                          await loadData(); // Reload to refresh activity assignments
                                        } catch (error) {
                                          alert(error.message);
                                        }
                                      }
                                    });
                                  }}
                                  className="px-3 py-1 text-red-600 hover:bg-red-100 rounded text-sm"
                                >
                                  L√∂schen
                                </button>
                              </td>
                            )}
                          </tr>
                        );
                      })}
                      {teamMembers.length === 0 && (
                        <tr>
                          <td colSpan={canManageTeam ? 11 : 6} className="p-6 text-center text-gray-500">
                            Noch keine Teammitglieder vorhanden. F√ºgen Sie oben ein neues Teammitglied hinzu.
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>

                {/* Backup section moved to header */}
              </div>
            )
          }

          {/* COPY SID DIALOG */}
          {/* Global Confirm Delete Dialog */}
          {deleteConfirm.isOpen && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm border border-gray-200">
                <h3 className="text-lg font-bold mb-2">{deleteConfirm.title}</h3>
                <p className="mb-6 text-sm text-gray-600">
                  {deleteConfirm.message}
                </p>
                <div className="flex justify-end gap-3 mt-6">
                  <button
                    onClick={() => setDeleteConfirm({ isOpen: false, title: '', message: '', onConfirm: null })}
                    className="px-4 py-2 border rounded hover:bg-gray-100 transition-colors text-sm"
                  >
                    Abbrechen
                  </button>
                  <button
                    onClick={async () => {
                      if (deleteConfirm.onConfirm) await deleteConfirm.onConfirm();
                      setDeleteConfirm({ isOpen: false, title: '', message: '', onConfirm: null });
                    }}
                    className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-sm"
                  >
                    L√∂schen
                  </button>
                </div>
              </div>
            </div>
          )}

          {copySidDialog.isOpen && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md border border-gray-200">
                <h3 className="text-xl font-bold mb-4">SID kopieren</h3>
                <p className="mb-4 text-sm text-gray-600">
                  Kopiert die gesamte SID inklusive aller zugeh√∂rigen Aktivit√§ten und Sub-Aktivit√§ten.
                </p>

                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Ziel-Landschaft</label>
                    <select
                      value={copySidDialog.targetLandscapeId}
                      onChange={e => setCopySidDialog(prev => ({ ...prev, targetLandscapeId: e.target.value }))}
                      className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:border-blue-500 bg-white"
                    >
                      <option value="" disabled>-- Bitte w√§hlen --</option>
                      {landscapes.map(l => (
                        <option key={l.id} value={l.id}>{l.name}</option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Name der neuen SID</label>
                    <input
                      type="text"
                      value={copySidDialog.newName}
                      onChange={e => {
                        const val = e.target.value.toUpperCase().replace(/[^A-Z0-9_\-]/g, '').substring(0, 8);
                        setCopySidDialog(prev => ({ ...prev, newName: val }));
                      }}
                      maxLength={8}
                      placeholder="Z.B. SID_COPY"
                      className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:border-blue-500 bg-white"
                    />
                  </div>
                </div>

                <div className="flex justify-end gap-3 mt-6">
                  <button
                    onClick={() => setCopySidDialog({ isOpen: false, sourceSidId: null, sourceLandscapeId: null, targetLandscapeId: '', newName: '' })}
                    className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                  >
                    Abbrechen
                  </button>
                  <button
                    onClick={handleCopySid}
                    disabled={!copySidDialog.targetLandscapeId || !copySidDialog.newName}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    title="SID kopieren ausf√ºhren"
                  >
                    Kopieren
                  </button>
                </div>
              </div>
            </div>
          )}


          {/* SID Info Edit Modal */}
          {
            editingSidInfo && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold">SID Informationen bearbeiten</h2>
                    <button
                      onClick={() => setEditingSidInfo(null)}
                      className="text-gray-500 hover:text-gray-700 text-2xl"
                    >
                      &times;
                    </button>
                  </div>

                  <div className="mb-4">
                    <label className="block text-gray-700 font-medium mb-2">Notizen & Infos (max. 5000 Zeichen)</label>
                    <textarea
                      value={editingSidInfo.notes}
                      onChange={(e) => setEditingSidInfo({ ...editingSidInfo, notes: e.target.value })}
                      className="w-full h-64 p-3 border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                      placeholder="Hier wichtige Informationen zum System eintragen..."
                      maxLength={5000}
                    />
                    <div className="text-right text-xs text-gray-500 mt-1">
                      {editingSidInfo.notes.length} / 5000 Zeichen
                    </div>
                  </div>

                  <div className="flex justify-end gap-3">
                    <button
                      onClick={() => setEditingSidInfo(null)}
                      className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
                    >
                      Abbrechen
                    </button>
                    <button
                      onClick={() => {
                        updateSID(editingSidInfo.landscapeId, editingSidInfo.sidId, 'notes', editingSidInfo.notes);
                        setEditingSidInfo(null);
                      }}
                      className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                      Speichern
                    </button>
                  </div>
                </div>
              </div>
            )
          }

          {/* Password Change Modal */}
          {
            showPasswordDialog && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold">Passwort √§ndern</h2>
                    <button
                      onClick={() => { setShowPasswordDialog(false); setPasswordError(''); setPasswordSuccess(''); }}
                      className="text-gray-500 hover:text-gray-700 text-2xl"
                    >
                      √ó
                    </button>
                  </div>

                  <form onSubmit={handlePasswordChange}>
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-1">Aktuelles Passwort</label>
                      <input
                        type="password"
                        name="currentPassword"
                        required
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                    </div>

                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-1">Neues Passwort</label>
                      <input
                        type="password"
                        name="newPassword"
                        required
                        minLength="6"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                    </div>

                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-1">Neues Passwort best√§tigen</label>
                      <input
                        type="password"
                        name="confirmPassword"
                        required
                        minLength="6"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      />
                    </div>

                    {passwordError && (
                      <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                        {passwordError}
                      </div>
                    )}

                    {passwordSuccess && (
                      <div className="mb-4 p-3 bg-green-100 text-green-700 rounded-lg text-sm">
                        {passwordSuccess}
                      </div>
                    )}

                    <div className="flex gap-2">
                      <button
                        type="button"
                        onClick={() => { setShowPasswordDialog(false); setPasswordError(''); setPasswordSuccess(''); }}
                        className="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                      >
                        Abbrechen
                      </button>
                      <button
                        type="submit"
                        className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                      >
                        Speichern
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            )
          }

          {/* User Management Modal */}
          {
            showUserDialog && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold">üë• Benutzerverwaltung</h2>
                    <button
                      onClick={() => setShowUserDialog(false)}
                      className="text-gray-500 hover:text-gray-700 text-2xl"
                    >
                      √ó
                    </button>
                  </div>

                  {userError && (
                    <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                      {userError}
                    </div>
                  )}

                  {/* User List */}
                  <div className="mb-6">
                    <h3 className="font-semibold mb-2">Vorhandene Benutzer:</h3>
                    <div className="border rounded-lg divide-y">
                      {users.map(u => {
                        // Determine if current user can delete this user
                        const canDeleteThisUser = u.id !== user.id && u.username !== 'teamlead' && (
                          user.role === 'teamlead' || (user.role === 'admin' && (u.role === 'user' || u.role === 'viewer'))
                        );

                        // Determine if current user can reset this user's password
                        let canResetPassword = false;
                        if (user.role === 'teamlead') {
                          if (user.username === 'teamlead') {
                            canResetPassword = true; // original system teamlead can reset anyone
                          } else {
                            canResetPassword = u.username !== 'teamlead'; // other teamleads cannot reset original teamlead
                          }
                        } else if (user.role === 'admin') {
                          canResetPassword = u.role !== 'teamlead'; // admins cannot reset any teamlead
                        }

                        return (
                          <div key={u.id} className="p-3 hover:bg-gray-50">
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-3">
                                <span className="font-medium">{u.username}</span>
                                {(u.first_name || u.last_name) && (
                                  <span className="text-sm text-gray-500">
                                    {u.first_name} {u.last_name}
                                  </span>
                                )}
                                <span className={`text-xs px-2 py-0.5 rounded ${u.role === 'teamlead' ? 'bg-amber-100 text-amber-700' :
                                  u.role === 'admin' ? 'bg-purple-100 text-purple-700' :
                                    u.role === 'viewer' ? 'bg-sky-100 text-sky-700' :
                                      'bg-gray-100 text-gray-600'
                                  }`}>
                                  {u.role === 'teamlead' ? 'Teamleiter' : u.role === 'admin' ? 'Administrator' : u.role === 'viewer' ? 'Viewer' : 'Benutzer'}
                                </span>
                              </div>
                              <div className="flex gap-2">
                                {canResetPassword && (
                                  <button
                                    type="button"
                                    onClick={() => handleResetPassword(u.id)}
                                    className={`text-sm px-2 py-1 border rounded ${resetPasswordUserId === u.id ? 'bg-blue-600 text-white border-blue-600' : 'text-blue-600 hover:text-blue-800 border-blue-300'}`}
                                  >
                                    üîë PW Reset
                                  </button>
                                )}
                                {canDeleteThisUser && (
                                  <button
                                    type="button"
                                    onClick={(e) => { e.preventDefault(); handleDeleteUser(u.id, u.username); }}
                                    className="text-sm px-2 py-1 text-red-600 hover:text-red-800 border border-red-300 rounded"
                                  >
                                    üóëÔ∏è L√∂schen
                                  </button>
                                )}
                              </div>
                            </div>
                            {resetPasswordUserId === u.id && (
                              <div className="mt-2 flex items-center gap-2 pl-4">
                                <input
                                  type="password"
                                  value={resetPasswordValue}
                                  onChange={(e) => setResetPasswordValue(e.target.value)}
                                  onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); submitResetPassword(); } }}
                                  placeholder="Neues Passwort (mind. 6 Zeichen)"
                                  className="flex-1 px-3 py-1.5 border border-gray-300 rounded text-sm"
                                  autoFocus
                                />
                                <button
                                  type="button"
                                  onClick={submitResetPassword}
                                  className="px-3 py-1.5 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
                                >
                                  Speichern
                                </button>
                                <button
                                  type="button"
                                  onClick={() => { setResetPasswordUserId(null); setResetPasswordValue(''); }}
                                  className="px-3 py-1.5 border border-gray-300 rounded text-sm hover:bg-gray-50"
                                >
                                  Abbrechen
                                </button>
                              </div>
                            )}
                            {confirmDeleteUserId === u.id && (
                              <div className="mt-2 flex items-center gap-2 pl-4 p-2 bg-red-50 rounded border border-red-200">
                                <span className="text-sm text-red-700 flex-1">Benutzer "{u.username}" wirklich l√∂schen?</span>
                                <button
                                  type="button"
                                  onClick={confirmDeleteUser}
                                  className="px-3 py-1.5 bg-red-600 text-white rounded text-sm hover:bg-red-700"
                                >
                                  Ja, l√∂schen
                                </button>
                                <button
                                  type="button"
                                  onClick={() => setConfirmDeleteUserId(null)}
                                  className="px-3 py-1.5 border border-gray-300 rounded text-sm hover:bg-gray-50"
                                >
                                  Abbrechen
                                </button>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* Add New User Form */}
                  {user?.role === 'teamlead' && (
                    <div className="border-t pt-4">
                      <h3 className="font-semibold mb-2">Neuen Benutzer anlegen:</h3>
                      <form onSubmit={handleAddUser} className="flex flex-col gap-2">
                        <div className="flex flex-wrap gap-2 items-end">
                          <div className="flex-1 min-w-32">
                            <label className="block text-xs text-gray-600 mb-1">Benutzername</label>
                            <input
                              type="text"
                              name="newUsername"
                              required
                              placeholder="username"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                            />
                          </div>
                          <div className="flex-1 min-w-32">
                            <label className="block text-xs text-gray-600 mb-1">Passwort</label>
                            <input
                              type="password"
                              name="newPassword"
                              required
                              minLength="6"
                              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                            />
                          </div>
                          <div className="w-36">
                            <label className="block text-xs text-gray-600 mb-1">Rolle</label>
                            <select name="newRole" className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                              <option value="user">Benutzer (Lesen)</option>
                              {user.role === 'teamlead' && <option value="admin">Administrator</option>}
                              {user.role === 'teamlead' && <option value="teamlead">Teamleiter</option>}
                              {user.role === 'teamlead' && <option value="viewer">Viewer (Nur Gantt)</option>}
                            </select>
                          </div>
                          <div className="w-20">
                            <label className="block text-xs text-gray-600 mb-1">K√ºrzel</label>
                            <input
                              type="text"
                              name="newAbbreviation"
                              readOnly
                              tabIndex={-1}
                              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-100 font-mono font-bold text-center uppercase"
                            />
                          </div>
                        </div>
                        <div className="flex flex-wrap gap-2 items-end">
                          <div className="flex-1 min-w-32">
                            <label className="block text-xs text-gray-600 mb-1">Vorname</label>
                            <input
                              type="text"
                              name="newFirstName"
                              required
                              placeholder="Vorname"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                              onInput={(e) => {
                                const form = e.target.form;
                                const fn = (form.newFirstName.value || '').trim().toUpperCase();
                                const ln = (form.newLastName.value || '').trim().toUpperCase();
                                form.newAbbreviation.value = (fn && ln) ? (fn[0] + ln[0] + ln[ln.length - 1]) : '';
                              }}
                            />
                          </div>
                          <div className="flex-1 min-w-32">
                            <label className="block text-xs text-gray-600 mb-1">Nachname</label>
                            <input
                              type="text"
                              name="newLastName"
                              required
                              placeholder="Nachname"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                              onInput={(e) => {
                                const form = e.target.form;
                                const fn = (form.newFirstName.value || '').trim().toUpperCase();
                                const ln = (form.newLastName.value || '').trim().toUpperCase();
                                form.newAbbreviation.value = (fn && ln) ? (fn[0] + ln[0] + ln[ln.length - 1]) : '';
                              }}
                            />
                          </div>
                          <button
                            type="submit"
                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
                          >
                            + Anlegen
                          </button>
                          <button
                            type="button"
                            onClick={() => setShowUserDialog(false)}
                            className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm"
                          >
                            Schlie√üen
                          </button>
                        </div>
                      </form>
                    </div>
                  )}

                </div>
              </div>
            )
          }

          {/* Skills & Schulungen Tab */}
          {
            activeTab === 'skills' && (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6 max-w-7xl mx-auto block-theme">
                <div className="flex justify-between items-center mb-6 border-b pb-4">
                  <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <span className="text-2xl">üéì</span> Skills & Schulungen
                  </h2>
                  <div className="flex gap-2">
                    {user?.role === 'teamlead' && (
                      <button
                        onClick={() => setAddSkillDialog({ isOpen: true, name: '' })}
                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium text-sm transition-colors"
                      >
                        + Skill hinzuf√ºgen
                      </button>
                    )}
                  </div>
                </div>

                {/* Qualifikationsmatrix */}
                <div className="mb-12">
                  <h3 className="text-xl font-semibold mb-4 text-gray-700">Qualifikationsmatrix</h3>
                  <div className="overflow-x-auto pb-4">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="bg-[#00b0f0] text-white">
                          <th className="p-3 text-left w-[180px] min-w-[180px] max-w-[180px] whitespace-normal break-words border-b border-[#00b0f0] font-semibold sticky left-0 z-20 bg-[#00b0f0] shadow-[1px_0_0_#00b0f0]">
                            Teammitglied
                          </th>
                          {matrixColumns.map(col => (
                            <th key={col.id} className="p-2 border-b border-[#00b0f0] bg-[#00b0f0] text-center w-[85px] min-w-[85px] max-w-[85px]">
                              <div className="flex items-center justify-center">
                                {user?.role === 'teamlead' ? (
                                  <div className="flex items-center justify-center relative group w-full">
                                    <textarea
                                      className="bg-transparent border-b border-transparent hover:border-white focus:border-white text-center font-semibold text-white w-full px-1 outline-none placeholder-blue-200 resize-none overflow-hidden"
                                      rows={2}
                                      style={{ wordBreak: 'break-word', lineHeight: '1.2' }}
                                      onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } }}
                                      defaultValue={col.name}
                                      onBlur={async (e) => {
                                        const newName = e.target.value.trim();
                                        if (newName && newName !== col.name) {
                                          try {
                                            await api.updateMatrixColumn(col.id, newName);
                                            setMatrixColumns(matrixColumns.map(c => c.id === col.id ? { ...c, name: newName } : c));
                                          } catch (error) {
                                            alert(error.message);
                                            e.target.value = col.name;
                                          }
                                        } else {
                                          e.target.value = col.name;
                                        }
                                      }}
                                    />
                                    <button
                                      onClick={async () => {
                                        if (confirm(`Spalte "${col.name}" wirklich l√∂schen?`)) {
                                          try {
                                            await api.deleteMatrixColumn(col.id);
                                            setMatrixColumns(matrixColumns.filter(c => c.id !== col.id));
                                            setMatrixValues(matrixValues.filter(v => v.column_id !== col.id));
                                          } catch (error) {
                                            alert(error.message);
                                          }
                                        }
                                      }}
                                      className="absolute right-0 text-white opacity-0 group-hover:opacity-100 p-1 hover:text-red-200"
                                      title="Spalte l√∂schen"
                                    >
                                      √ó
                                    </button>
                                  </div>
                                ) : (
                                  <span className="font-semibold text-white text-sm whitespace-normal break-words inline-block w-full">{col.name}</span>
                                )}
                              </div>
                            </th>
                          ))}
                          {/* Spacer content to absorb table width when the browser window is wide */}
                          <th className="w-full p-0 border-b border-[#00b0f0] bg-[#00b0f0]"></th>
                          {matrixColumns.length > 0 && (
                            <th className="p-2 border-b border-[#00b0f0] bg-[#00b0f0] text-center w-10 min-w-[40px] max-w-[40px] sticky right-[32px] z-20 shadow-[-1px_0_0_#00b0f0]">
                            </th>
                          )}
                          {matrixColumns.length > 0 && (
                            <th className="p-0 border-b border-[#00b0f0] bg-[#00b0f0] w-8 min-w-[32px] max-w-[32px] sticky right-0 z-30">
                            </th>
                          )}
                        </tr>
                      </thead>
                      <tbody>
                        {teamMembers.map((member, index) => {
                          let memberTotalScore = 0;
                          const possibleScore = matrixColumns.length * 4;
                          const memberCanEdit = user?.role === 'teamlead' || (user?.username && (user.username.toLowerCase() === member.name.toLowerCase() || user.username.toUpperCase() === member.abbreviation.toUpperCase()));

                          return (
                            <tr key={member.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                              <td className={`p-3 border-b border-gray-200 font-medium text-gray-800 sticky left-0 z-10 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} shadow-[1px_0_0_#e5e7eb] w-[180px] min-w-[180px] max-w-[180px] whitespace-normal break-words`}>
                                {member.name.split(' ').map((part, i, arr) => (
                                  <span key={i}>
                                    {part}
                                    {arr.length > 1 && i === 0 && <br />}
                                    {arr.length > 1 && i > 0 && i < arr.length - 1 && ' '}
                                  </span>
                                ))}
                              </td>
                              {matrixColumns.map(col => {
                                const val = matrixValues.find(v => v.team_member_id === member.id && v.column_id === col.id);
                                const level = val ? val.level : 0;
                                memberTotalScore += level;

                                let bgColor = 'bg-transparent text-transparent'; // Default is invisible (0) // MODIFIED: bg-white -> bg-transparent to match mockup
                                let borderColor = 'border-gray-500/30'; // MODIFIED: To match mockup default cell border
                                let textColor = 'text-transparent';

                                if (level === 1) { bgColor = 'bg-red-500'; borderColor = 'border-red-500'; textColor = 'text-white'; }
                                else if (level === 2) { bgColor = 'bg-amber-400'; borderColor = 'border-amber-400'; textColor = 'text-white'; }
                                else if (level === 3) { bgColor = 'bg-[#92d050]'; borderColor = 'border-[#92d050]'; textColor = 'text-white'; }
                                else if (level === 4) { bgColor = 'bg-[#00b050]'; borderColor = 'border-[#00b050]'; textColor = 'text-white'; }

                                return (
                                  <td key={col.id} className="p-1 border-b border-gray-200 text-center">
                                    <div className="flex justify-center">
                                      <button
                                        disabled={!memberCanEdit}
                                        onClick={async () => {
                                          if (!memberCanEdit) return;
                                          const nextLevel = level >= 4 ? 0 : level + 1;
                                          try {
                                            await api.updateMatrixValue(member.id, col.id, nextLevel);
                                            setMatrixValues(prev => {
                                              const filtered = prev.filter(v => !(v.team_member_id === member.id && v.column_id === col.id));
                                              return [...filtered, { team_member_id: member.id, column_id: col.id, level: nextLevel }];
                                            });
                                          } catch (error) {
                                            alert(error.message);
                                          }
                                        }}
                                        className={`w-6 h-6 rounded-sm border shrink-0 flex items-center justify-center font-bold text-xs transition-opacity focus:outline-none focus:ring-1 focus:ring-offset-1 focus:ring-blue-400 ${bgColor} ${borderColor} ${textColor} ${memberCanEdit ? 'cursor-pointer hover:opacity-80' : 'cursor-default'}`}
                                        title={level > 0 ? `Level: ${level}` : 'Kein Level'}
                                      >
                                        {level > 0 ? level : ''}
                                      </button>
                                    </div>
                                  </td>
                                );
                              })}
                              {/* Spacer content to absorb table width */}
                              <td className="w-full p-0 border-b border-gray-200"></td>
                              {matrixColumns.length > 0 && (
                                <td className={`p-2 border-b border-gray-200 text-center font-bold text-gray-800 text-sm sticky right-[32px] z-10 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} shadow-[-1px_0_0_#e5e7eb] w-10 min-w-[40px] max-w-[40px]`}>
                                  {possibleScore > 0 ? Math.round((memberTotalScore / possibleScore) * 100) : 0}%
                                </td>
                              )}
                              {matrixColumns.length > 0 && index === 0 && (
                                <td rowSpan={teamMembers.length + 1} className="p-1 border-t border-b border-gray-300 bg-gray-200 text-center border-l shadow-inner w-8 min-w-[32px] max-w-[32px] align-middle sticky right-0 z-20">
                                  <div className="flex flex-col items-center justify-center h-full">
                                    <span className="transform -rotate-180 text-gray-900 font-bold tracking-wider text-sm whitespace-nowrap" style={{ writingMode: 'vertical-rl' }}>
                                      Themenabdeckung Mitarbeiter
                                    </span>
                                  </div>
                                </td>
                              )}
                            </tr>
                          );
                        })}
                        {teamMembers.length > 0 && matrixColumns.length > 0 && (
                          <tr className="bg-gray-100 relative">
                            <td className="p-3 border-t-2 border-b border-gray-300 font-bold text-gray-800 sticky left-0 z-10 bg-gray-100 shadow-[1px_0_0_#d1d5db] text-center w-[180px] min-w-[180px] max-w-[180px]">
                              <div className="flex flex-col items-center">
                                <span>Themenabdeckung</span>
                                <span>Team</span>
                              </div>
                            </td>
                            {matrixColumns.map(col => {
                              let colTotalScore = 0;
                              const possibleColScore = teamMembers.length * 4;

                              teamMembers.forEach(member => {
                                const val = matrixValues.find(v => v.team_member_id === member.id && v.column_id === col.id);
                                if (val) {
                                  colTotalScore += val.level;
                                }
                              });

                              return (
                                <td key={`total-${col.id}`} className="p-2 border-t-2 border-b border-gray-300 text-center font-bold text-gray-800 text-sm">
                                  {possibleColScore > 0 ? Math.round((colTotalScore / possibleColScore) * 100) : 0}%
                                </td>
                              );
                            })}
                            <td className="w-full p-0 border-t-2 border-b border-gray-300 bg-gray-100"></td>
                            <td className="p-2 border-t-2 border-b border-gray-300 bg-gray-100 sticky right-[32px] z-10 shadow-[-1px_0_0_#d1d5db] w-10 min-w-[40px] max-w-[40px]"></td>
                          </tr>
                        )}
                        {teamMembers.length === 0 && (
                          <tr>
                            <td colSpan={matrixColumns.length + 1} className="p-6 text-center text-gray-500 italic">
                              Bitte legen Sie zuerst Teammitglieder im Reiter "Team-Auslastung" an.
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* Schulungen Tabelle */}
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-semibold text-gray-700">Schulungen</h3>
                    {canEdit && (
                      <button
                        onClick={async () => {
                          try {
                            const newTr = await api.createTraining();
                            setTrainings([...trainings, newTr]);
                          } catch (error) {
                            alert(error.message);
                          }
                        }}
                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium text-sm transition-colors"
                      >
                        + Schulung eintragen
                      </button>
                    )}
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse border border-[#00b0f0]">
                      <thead>
                        <tr className="bg-[#00b0f0] text-white">
                          <th className="p-2 border border-[#00b0f0] bg-[#00b0f0] font-semibold text-left">Teilnehmer</th>
                          <th className="p-2 border border-[#00b0f0] bg-[#00b0f0] font-semibold text-left">Kurs</th>
                          <th className="p-2 border border-[#00b0f0] bg-[#00b0f0] font-semibold text-left">Thema</th>
                          <th className="p-2 border border-[#00b0f0] bg-[#00b0f0] font-semibold text-left">Kosten</th>
                          <th className="p-2 border border-[#00b0f0] bg-[#00b0f0] font-semibold text-left">Location</th>
                          <th className="p-2 border border-[#00b0f0] bg-[#00b0f0] font-semibold text-center">Termin1</th>
                          <th className="p-2 border border-[#00b0f0] bg-[#00b0f0] font-semibold text-center">Termin2</th>
                          <th className="p-2 border border-[#00b0f0] bg-[#00b0f0] font-semibold text-center">Termin3</th>
                          <th className="p-2 border border-[#00b0f0] bg-[#00b0f0] font-semibold text-center whitespace-nowrap">Anzahl Tage</th>
                          {canEdit && <th className="p-2 border border-[#00b0f0] bg-[#00b0f0] font-semibold text-center w-12">Aktion</th>}
                        </tr>
                      </thead>
                      <tbody>
                        {trainings.map((tr, index) => (
                          <tr key={tr.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                            <td className={`p-0 border border-gray-300 transition-colors ${tr.booked_date > 0 ? 'booked-green' : ''}`}>
                              <select
                                value={tr.participants || ''}
                                onChange={(e) => {
                                  setTrainings(trainings.map(t => t.id === tr.id ? { ...t, participants: e.target.value } : t));
                                  api.updateTraining(tr.id, { participants: e.target.value }).catch(err => console.error(err));
                                }}
                                disabled={!canEdit}
                                className={`w-full p-2 outline-none text-sm appearance-none ${tr.booked_date > 0 ? 'booked-green font-medium' : 'bg-transparent text-gray-800 hover:bg-gray-100 focus:bg-blue-50'}`}
                              >
                                <option value="" className="text-gray-800">-- Ausw√§hlen --</option>
                                {teamMembers.map(m => (
                                  <option key={m.id} value={m.name} className="text-gray-800">{m.name}</option>
                                ))}
                              </select>
                            </td>
                            <td className="p-0 border border-gray-300">
                              <input
                                type="text"
                                value={tr.course || ''}
                                onChange={(e) => setTrainings(trainings.map(t => t.id === tr.id ? { ...t, course: e.target.value } : t))}
                                onBlur={(e) => api.updateTraining(tr.id, { course: e.target.value }).catch(err => console.error(err))}
                                disabled={!canEdit}
                                className="w-full p-2 bg-transparent outline-none focus:bg-blue-50 text-sm"
                              />
                            </td>
                            <td className="p-0 border border-gray-300">
                              <input
                                type="text"
                                value={tr.topic || ''}
                                onChange={(e) => setTrainings(trainings.map(t => t.id === tr.id ? { ...t, topic: e.target.value } : t))}
                                onBlur={(e) => api.updateTraining(tr.id, { topic: e.target.value }).catch(err => console.error(err))}
                                disabled={!canEdit}
                                className="w-full p-2 bg-transparent outline-none focus:bg-blue-50 text-sm"
                              />
                            </td>
                            <td className="p-0 border border-gray-300 min-w-28">
                              <input
                                type="text"
                                value={tr.cost || ''}
                                onChange={(e) => setTrainings(trainings.map(t => t.id === tr.id ? { ...t, cost: e.target.value } : t))}
                                onBlur={(e) => api.updateTraining(tr.id, { cost: e.target.value }).catch(err => console.error(err))}
                                disabled={!canEdit}
                                className="w-full p-2 bg-transparent outline-none focus:bg-blue-50 text-sm"
                                placeholder="‚Ç¨..."
                              />
                            </td>
                            <td className="p-0 border border-gray-300">
                              <input
                                type="text"
                                value={tr.location || ''}
                                onChange={(e) => setTrainings(trainings.map(t => t.id === tr.id ? { ...t, location: e.target.value } : t))}
                                onBlur={(e) => api.updateTraining(tr.id, { location: e.target.value }).catch(err => console.error(err))}
                                disabled={!canEdit}
                                className="w-full p-2 bg-transparent outline-none focus:bg-blue-50 text-sm"
                              />
                            </td>
                            <td className={`p-1 border border-gray-300 w-36 transition-colors ${tr.booked_date === 1 ? 'booked-green' : ''}`}>
                              <div className="flex items-center space-x-1 h-full">
                                {canEdit && tr.date1 && (
                                  <input
                                    type="checkbox"
                                    checked={tr.booked_date === 1}
                                    onChange={async (e) => {
                                      const termDate = new Date(tr.date1);
                                      const today = new Date();
                                      today.setHours(0, 0, 0, 0);
                                      if (termDate < today) {
                                        e.preventDefault();
                                        alert('Ein Termin in der Vergangenheit kann nicht gebucht werden.');
                                        return;
                                      }
                                      const newStatus = tr.booked_date === 1 ? 0 : 1;
                                      try {
                                        await api.updateTraining(tr.id, { booked_date: newStatus });
                                        setTrainings(trainings.map(t => t.id === tr.id ? { ...t, booked_date: newStatus } : t));
                                      } catch (error) {
                                        alert('Fehler beim Speichern: ' + error.message);
                                      }
                                    }}
                                    className="cursor-pointer w-4 h-4 ml-1"
                                    title="Diesen Termin buchen"
                                  />
                                )}
                                <input
                                  type="date"
                                  value={tr.date1 || ''}
                                  onChange={(e) => setTrainings(trainings.map(t => t.id === tr.id ? { ...t, date1: e.target.value } : t))}
                                  onBlur={(e) => api.updateTraining(tr.id, { date1: e.target.value }).catch(err => console.error(err))}
                                  disabled={!canEdit}
                                  className={`w-full p-1 outline-none text-xs flex-1 ${tr.booked_date === 1 ? 'booked-green font-medium' : 'bg-transparent text-inherit hover:bg-gray-100 focus:bg-blue-50'}`}
                                />
                              </div>
                            </td>
                            <td className={`p-1 border border-gray-300 w-36 transition-colors ${tr.booked_date === 2 ? 'booked-green' : ''}`}>
                              <div className="flex items-center space-x-1 h-full">
                                {canEdit && tr.date2 && (
                                  <input
                                    type="checkbox"
                                    checked={tr.booked_date === 2}
                                    onChange={async (e) => {
                                      const termDate = new Date(tr.date2);
                                      const today = new Date();
                                      today.setHours(0, 0, 0, 0);
                                      if (termDate < today) {
                                        e.preventDefault();
                                        alert('Ein Termin in der Vergangenheit kann nicht gebucht werden.');
                                        return;
                                      }
                                      const newStatus = tr.booked_date === 2 ? 0 : 2;
                                      try {
                                        await api.updateTraining(tr.id, { booked_date: newStatus });
                                        setTrainings(trainings.map(t => t.id === tr.id ? { ...t, booked_date: newStatus } : t));
                                      } catch (error) {
                                        alert('Fehler beim Speichern: ' + error.message);
                                      }
                                    }}
                                    className="cursor-pointer w-4 h-4 ml-1"
                                    title="Diesen Termin buchen"
                                  />
                                )}
                                <input
                                  type="date"
                                  value={tr.date2 || ''}
                                  onChange={(e) => setTrainings(trainings.map(t => t.id === tr.id ? { ...t, date2: e.target.value } : t))}
                                  onBlur={(e) => api.updateTraining(tr.id, { date2: e.target.value }).catch(err => console.error(err))}
                                  disabled={!canEdit}
                                  className={`w-full p-1 outline-none text-xs flex-1 ${tr.booked_date === 2 ? 'booked-green font-medium' : 'bg-transparent text-inherit hover:bg-gray-100 focus:bg-blue-50'}`}
                                />
                              </div>
                            </td>
                            <td className={`p-1 border border-gray-300 w-36 transition-colors ${tr.booked_date === 3 ? 'booked-green' : ''}`}>
                              <div className="flex items-center space-x-1 h-full">
                                {canEdit && tr.date3 && (
                                  <input
                                    type="checkbox"
                                    checked={tr.booked_date === 3}
                                    onChange={async (e) => {
                                      const termDate = new Date(tr.date3);
                                      const today = new Date();
                                      today.setHours(0, 0, 0, 0);
                                      if (termDate < today) {
                                        e.preventDefault();
                                        alert('Ein Termin in der Vergangenheit kann nicht gebucht werden.');
                                        return;
                                      }
                                      const newStatus = tr.booked_date === 3 ? 0 : 3;
                                      try {
                                        await api.updateTraining(tr.id, { booked_date: newStatus });
                                        setTrainings(trainings.map(t => t.id === tr.id ? { ...t, booked_date: newStatus } : t));
                                      } catch (error) {
                                        alert('Fehler beim Speichern: ' + error.message);
                                      }
                                    }}
                                    className="cursor-pointer w-4 h-4 ml-1"
                                    title="Diesen Termin buchen"
                                  />
                                )}
                                <input
                                  type="date"
                                  value={tr.date3 || ''}
                                  onChange={(e) => setTrainings(trainings.map(t => t.id === tr.id ? { ...t, date3: e.target.value } : t))}
                                  onBlur={(e) => api.updateTraining(tr.id, { date3: e.target.value }).catch(err => console.error(err))}
                                  disabled={!canEdit}
                                  className={`w-full p-1 outline-none text-xs flex-1 ${tr.booked_date === 3 ? 'booked-green font-medium' : 'bg-transparent text-inherit hover:bg-gray-100 focus:bg-blue-50'}`}
                                />
                              </div>
                            </td>
                            <td className="p-0 border border-gray-300 w-16">
                              <input
                                type="number"
                                min="0"
                                value={tr.days !== undefined && tr.days !== null ? tr.days : ''}
                                onChange={(e) => {
                                  const v = e.target.value !== '' ? parseInt(e.target.value) || 0 : '';
                                  setTrainings(trainings.map(t => t.id === tr.id ? { ...t, days: v } : t));
                                }}
                                onBlur={(e) => {
                                  const v = e.target.value !== '' ? parseInt(e.target.value) || 0 : 0;
                                  api.updateTraining(tr.id, { days: v }).catch(err => console.error(err));
                                }}
                                disabled={!canEdit}
                                className="w-full p-2 bg-transparent outline-none focus:bg-blue-50 text-sm text-center"
                              />
                            </td>
                            {canEdit && (
                              <td className="p-2 border border-gray-300 text-center">
                                <button
                                  onClick={async () => {
                                    if (confirm('Schulung wirklich l√∂schen?')) {
                                      try {
                                        await api.deleteTraining(tr.id);
                                        setTrainings(trainings.filter(t => t.id !== tr.id));
                                      } catch (error) {
                                        alert(error.message);
                                      }
                                    }
                                  }}
                                  className="text-red-500 hover:text-red-700 font-bold"
                                  title="Schulung l√∂schen"
                                >
                                  √ó
                                </button>
                              </td>
                            )}
                          </tr>
                        ))}
                        {trainings.length === 0 && (
                          <tr>
                            <td colSpan={canEdit ? 10 : 9} className="p-6 text-center text-gray-500 italic border border-gray-300">
                              Noch keine Schulungen eingetragen.
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>

              </div>
            )
          }

          {/* Footer - visible on all tabs */}
          <div className="text-center text-gray-500 text-sm mt-8 mb-4">
            SAP Basis Jahresplaner ‚Ä¢ {year} ‚Ä¢ {appVersion && `Version ${appVersion} ‚Ä¢ `}Optima Solutions GmbH ‚Ä¢ Daten werden in SQLite-Datenbank gespeichert
          </div>

          {/* Logs Modal */}
          {
            showLogsDialog && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold">üìã Logfiles</h2>
                    <button
                      onClick={() => setShowLogsDialog(false)}
                      className="text-gray-500 hover:text-gray-700 text-2xl"
                    >
                      √ó
                    </button>
                  </div>

                  {logsLoading ? (
                    <div className="text-center py-8 text-gray-500">Lade Logs...</div>
                  ) : !logs ? (
                    <div className="text-center py-8 text-gray-500">Keine Logs vorhanden</div>
                  ) : (
                    <div className="bg-gray-100 p-4 rounded-lg overflow-x-auto">
                      <pre className="font-mono text-xs whitespace-pre-wrap max-h-[60vh] overflow-y-auto">
                        {logs}
                      </pre>
                    </div>
                  )}

                  <div className="mt-6 text-right">
                    <button
                      onClick={() => setShowLogsDialog(false)}
                      className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                      Schlie√üen
                    </button>
                  </div>
                </div>
              </div>
            )
          }

          {/* Maintenance Sundays Modal */}
          {
            showMaintenanceDialog && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold">üîß Wartungssonntage</h2>
                    <button
                      onClick={() => setShowMaintenanceDialog(false)}
                      className="text-gray-500 hover:text-gray-700 text-2xl"
                    >
                      √ó
                    </button>
                  </div>

                  <p className="text-sm text-gray-600 mb-4">
                    Wartungssonntage werden im Gantt-Diagramm lila markiert und wie Feiertage behandelt.
                  </p>

                  {maintenanceLoading ? (
                    <div className="text-center py-8 text-gray-500">Laden...</div>
                  ) : (
                    <div className="space-y-3">
                      {[1, 2, 3, 4].map(id => {
                        const sunday = maintenanceSundays.find(s => s.id === id);
                        return (
                          <div key={id} className="flex items-center gap-3">
                            <label className="w-32 font-medium text-purple-700">
                              Wartungssonntag {['I', 'II', 'III', 'IV'][id - 1]}
                            </label>
                            <input
                              type="date"
                              value={sunday?.date || ''}
                              min="2026-01-01"
                              max="2036-12-31"
                              onChange={(e) => handleMaintenanceSundayUpdate(id, e.target.value)}
                              className="flex-1 px-3 py-2 border border-gray-300 rounded-lg"
                            />
                          </div>
                        );
                      })}
                    </div>
                  )}

                  <div className="mt-6 text-right">
                    <button
                      onClick={() => setShowMaintenanceDialog(false)}
                      className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                    >
                      Fertig
                    </button>
                  </div>
                </div>
              </div>
            )
          }

          {/* Add Skill Dialog */}
          {
            addSkillDialog.isOpen && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white p-6 rounded shadow-lg max-w-sm w-full">
                  <h3 className="text-xl font-bold mb-4">Neuen Skill anlegen</h3>
                  <form onSubmit={async (e) => {
                    e.preventDefault();
                    if (!addSkillDialog.name.trim()) return;
                    try {
                      const newCol = await api.createMatrixColumn(addSkillDialog.name.trim());
                      setMatrixColumns([...matrixColumns, newCol]);
                      setAddSkillDialog({ isOpen: false, name: '' });
                    } catch (error) {
                      alert('Fehler beim Erstellen der Spalte: ' + error.message);
                    }
                  }}>
                    <input
                      type="text"
                      value={addSkillDialog.name}
                      onChange={(e) => setAddSkillDialog({ ...addSkillDialog, name: e.target.value })}
                      className="w-full border border-gray-300 p-2 rounded mb-4"
                      placeholder="Name des Skills (z.B. Linux Server)"
                      autoFocus
                    />
                    <div className="flex justify-end gap-2">
                      <button
                        type="button"
                        onClick={() => setAddSkillDialog({ isOpen: false, name: '' })}
                        className="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400"
                      >
                        Abbrechen
                      </button>
                      <button
                        type="submit"
                        disabled={!addSkillDialog.name.trim()}
                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
                      >
                        Erstellen
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            )
          }
        </div>
      );
    };

    ReactDOM.render(<SAPBasisPlanner />, document.getElementById('root'));
  </script>
</body>

</html>